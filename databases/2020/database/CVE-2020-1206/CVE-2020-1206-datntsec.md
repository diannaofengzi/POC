# CVE-2020-1206

null

| Infos    | Value                                                              |
| -------- | -------------------------------------------------------------------|
| Username | [https://github.com/datntsec](https://github.com/datntsec) |
| Url      | [https://github.com/datntsec/CVE-2020-1206](https://github.com/datntsec/CVE-2020-1206)                                               |
| Stars    | 0                                                          |
| License  | No License                                                        |

<details>

<summary>Topic / Tags</summary>



</details>

## Readme

Trong lá»— há»ng SMBGhost ([CVE-2020-0796](https://github.com/datntsec/CVE-2020-0796)) tÃ´i Ä‘Ã£ nÃ³i vá» má»™t kÄ© thuáº­t write-what-where primitive thÃ´ng qua viá»‡c sá»­ dá»¥ng bug overflow integer Ä‘á»ƒ thay Ä‘á»•i con trá» Alloc.Userbuffer trá» Ä‘áº¿n má»™t Ä‘á»‹a chá»‰ mÃ  ta mong muá»‘n vÃ  ghi dá»¯ liá»‡u tÃ¹y Ã½ vÃ o Ä‘Ã³. TÆ°Æ¡ng tá»± nhÆ° SMB Ghost, lá»— há»ng nÃ y cÅ©ng tá»•n táº¡i á»Ÿ hÃ m Srv2DecompressData trong srv2.sys. CÃ¹ng xem láº¡i hÃ m Srv2DecompressData liÃªn quan Ä‘áº¿n lá»— há»ng SMBGhost (CVE-2020-0796) Ä‘Ã£ Ä‘Æ°á»£c Ä‘Æ¡n giáº£n hÃ³a bá»Ÿi [Zecops](https://blog.zecops.com)
``` c
typedef struct _COMPRESSION_TRANSFORM_HEADER
{
    ULONG ProtocolId;
    ULONG OriginalCompressedSegmentSize;
    USHORT CompressionAlgorithm;
    USHORT Flags;
    ULONG Offset;
} COMPRESSION_TRANSFORM_HEADER, *PCOMPRESSION_TRANSFORM_HEADER;
 
 
typedef struct _ALLOCATION_HEADER
{
    // ...
    PVOID UserBuffer;
    // ...
} ALLOCATION_HEADER, *PALLOCATION_HEADER;
 
 
NTSTATUS Srv2DecompressData(PCOMPRESSION_TRANSFORM_HEADER Header, SIZE_T TotalSize)
{
    PALLOCATION_HEADER Alloc = SrvNetAllocateBuffer(
        (ULONG)(Header->OriginalCompressedSegmentSize + Header->Offset),
        NULL);
    If (!Alloc) {
        return STATUS_INSUFFICIENT_RESOURCES;
    }
 
 
    ULONG FinalCompressedSize = 0;
 
 
    NTSTATUS Status = SmbCompressionDecompress(
        Header->CompressionAlgorithm,
        (PUCHAR)Header + sizeof(COMPRESSION_TRANSFORM_HEADER) + Header->Offset,
        (ULONG)(TotalSize - sizeof(COMPRESSION_TRANSFORM_HEADER) - Header->Offset),
        (PUCHAR)Alloc->UserBuffer + Header->Offset,
        Header->OriginalCompressedSegmentSize,
        &FinalCompressedSize);
    if (Status < 0 || FinalCompressedSize != Header->OriginalCompressedSegmentSize) {
        SrvNetFreeBuffer(Alloc);
        return STATUS_BAD_DATA;
    }
 
 
    if (Header->Offset > 0) {
        memcpy(
            Alloc->UserBuffer,
            (PUCHAR)Header + sizeof(COMPRESSION_TRANSFORM_HEADER),
            Header->Offset);
    }
 
 
    Srv2ReplaceReceiveBuffer(some_session_handle, Alloc);
    return STATUS_SUCCESS;
}

```

HÃ m Srv2DecompressData nháº­n vÃ o má»™t message Ä‘Æ°á»£c nÃ©n do client gá»­i Ä‘áº¿n vÃ  tiáº¿n hÃ nh cáº¥p phÃ¡t má»™t vÃ¹ng nhá»› cáº§n thiáº¿t, giáº£i nÃ©n message vÃ o Ä‘Ã³. Sau Ä‘Ã³, náº¿u trÆ°á»ng Offset khÃ¡c khÃ´ng, nÃ³ sáº½ copy data (RawData) á»Ÿ trÆ°á»›c data Ä‘Æ°á»£c nÃ©n vÃ o pháº§n Ä‘áº§u vÃ¹ng nhá»› Ä‘Æ°á»£c cáº¥p phÃ¡t.

![](pic/pic1.png)

Lá»—i SMBGhost náº±m á»Ÿ viá»‡c hÃ m khÃ´ng kiá»ƒm tra integer overflow, dáº«n Ä‘áº¿n cáº¥p phÃ¡t sai kÃ­ch thÆ°á»›c gÃ¢y ra buffer overflow. Sau 3 thÃ¡ng ká»ƒ tá»« ngÃ y Microsoft vÃ¡ SMBGhost, lá»— há»ng CVE-2020-1206 (SMBleed - theo cÃ¡ch gá»i cá»§a [Zecops Blog](https://blog.zecops.com/)) Ä‘Æ°á»£c tÃ¬m tháº¥y. Lá»— há»ng nÃ y cho phÃ©p chÃºng ta leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a mÃ¡y khÃ¡c, vÃ  náº¿u káº¿t há»£p vá»›i SMBGhost, ta cÃ³ thá»ƒ cÃ³ Ä‘Æ°á»£c RCE. Äá»ƒ cÃ³ cÃ¡i nhÃ¬n Ä‘Æ¡n giáº£n hÆ¡n vá» hÃ m Srv2DecompressData, ta sáº½ dÃ¹ng láº¡i hÃ m nÃ y khi chÆ°a Ä‘Æ°á»£c vÃ¡ lá»—i SMBGhost vÃ  giáº£ sá»­ ráº±ng nÃ³ Ä‘Ã£ Ä‘Æ°á»£c vÃ¡.

# Giáº£ máº¡o OriginalCompressedSegmentSize
NhÆ° SMBGhost, láº§n nÃ y ta váº«n sáº½ giáº£ máº¡o OriginalCompressedSegmentSize vá»›i má»™t sá»‘ lá»›n hÆ¡n má»™t chÃºt so vá»›i dá»¯ liá»‡u giáº£i nÃ©n mÃ  ta gá»­i. VÃ­ dá»¥ ta nÃ©n má»™t data cÃ³ kÃ­ch thÆ°á»›c x byte, thay vÃ¬ Ä‘áº·t vÃ o trÆ°á»ng OriginalCompressedSegmentSize x, ta sáº½ Ä‘áº·t thÃ nh x + 0x1000, xem hÃ¬nh sau sáº½ rÃµ hÆ¡n:

![](pic/pic2.png)

Uninitialized kernel data sáº½ Ä‘Æ°á»£c coi nhÆ° má»™t pháº§n cá»§a message.

NhÆ° á»Ÿ bÃ i phÃ¢n tÃ­ch [CVE-2020-0796](https://github.com/datntsec/CVE-2020-0796) tÃ´i cÃ³ nÃ³i, Srv2DecompressData váº«n sáº½ bá» qua giai Ä‘oáº¡n kiá»ƒm tra sau hÃ m SmbCompressionDecompress náº¿u viá»‡c decompress diá»…n ra thÃ nh cÃ´ng:
``` c
if (Status < 0 || FinalCompressedSize != Header->OriginalCompressedSegmentSize) {
    SrvNetFreeBuffer(Alloc);
    return STATUS_BAD_DATA;
}
```

Máº·c dÃ¹ trÆ°á»ng OriginalCompressedSegmentSize Ä‘Æ°á»£c Ä‘áº·t thÃ nh x + 0x1000 thay vÃ¬ x, nhÆ°ng sau khi giáº£i nÃ©n thÃ nh cÃ´ng, biáº¿n FinalCompressedSize khÃ´ng chá»©a giÃ¡ trá»‹ x, mÃ  sáº½ chá»©a giÃ¡ trá»‹ x + 0x1000:
```c
NTSTATUS SmbCompressionDecompress(
    USHORT CompressionAlgorithm,
    PUCHAR UncompressedBuffer,
    ULONG  UncompressedBufferSize,
    PUCHAR CompressedBuffer,
    ULONG  CompressedBufferSize,
    PULONG FinalCompressedSize)
{
    // ...
 
    NTSTATUS Status = RtlDecompressBufferEx2(
        ...,
        FinalUncompressedSize,
        ...);
    if (status >= 0) {
        *FinalCompressedSize = CompressedBufferSize;
    }
 
    // ...
 
    return Status;
}
```

Bá»Ÿi vÃ¬ sau khi giáº£i nÃ©n thÃ nh cÃ´ng, FinalCompressedSize Ä‘Æ°á»£c cáº­p nháº­t Ä‘á»ƒ giá»¯ giÃ¡ trá»‹ CompressedBufferSize (tÆ°Æ¡ng á»©ng vá»›i OriginalCompressedSegmentSize Ä‘Æ°á»£c truyá»n vÃ o hÃ m SmbCompressionDecompress). Viá»‡c cáº­p nháº­t vÃ  kiá»ƒm tra sau Ä‘Ã³ lÃ  gáº§n nhÆ° khÃ´ng cáº§n thiáº¿t, cÃ³ thá»ƒ dáº«n Ä‘áº¿n má»™t sá»‘ lá»—i khÃ´ng mong muá»‘n.


# Khai thÃ¡c á»Ÿ má»©c cÆ¡ báº£n
Cáº¥u trÃºc message mÃ  Zecops sá»­ dá»¥ng Ä‘á»ƒ chá»©ng minh lá»— há»ng lÃ  [SMB2 WRITE message](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/e7046961-3318-4350-be2a-a8d69bb59ce8). Cáº¥u trÃºc nÃ y chá»©a cÃ¡c trÆ°á»ng nhÆ° sá»‘ byte cÃ³ thá»ƒ write, flag,..., theo sau lÃ  má»™t buffer cÃ³ Ä‘á»™ dÃ i tÃ¹y Ã½. Äiá»u nÃ y khÃ¡ hoÃ n háº£o Ä‘á»ƒ khai thÃ¡c lá»—i, vÃ¬ ta cÃ³ thá»ƒ táº¡o má»™t message vÃ  chá»‰ Ä‘á»‹nh header, vá»›i má»™t buffer chá»©a data chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o.

Dá»±a trÃªn POC cá»§a [Zecops](https://blog.zecops.com/) trÃªn kho lÆ°u trá»¯ WindowsProtocolTestSuites cá»§a Microsoft, Ä‘á»ƒ Ä‘á»ƒ cÃ³ cÃ¡i nhÃ¬n rÃµ hÆ¡n vá» vá» Ä‘iá»u nÃ y, ta sáº½ thÃªm pháº§n bá»• sung nhá» nÃ y cho hÃ m compression:
``` c
// HACK: fake size
if (((Smb2SinglePacket)packet).Header.Command == Smb2Command.WRITE)
{
    ((Smb2WriteRequestPacket)packet).PayLoad.Length += 0x1000;
    compressedPacket.Header.OriginalCompressedSegmentSize += 0x1000;
}
```

LÆ°u Ã½ ráº±ng POC nÃ y yÃªu cáº§u thÃ´ng tin xÃ¡c thá»±c vÃ  chia sáº» quyá»n write, thÆ°á»ng cÃ³ sáºµn trong nhiá»u trÆ°á»ng há»£p. Tuy nhiÃªn, lá»—i tráº£ vá» sáº½ Ã¡p dá»¥ng cho má»i message (bao gá»“m cáº£ message cÃ³ hoáº·c khÃ´ng cÃ³ thÃ´ng tin xÃ¡c thá»±c), nÃªn cÃ³ kháº£ nÄƒng ta sáº½ cÃ³ thá»ƒ khai thÃ¡c mÃ  khÃ´ng cáº§n pháº£i xÃ¡c thá»±c. Má»™t Ä‘iá»u ná»¯a, lÃ  bá»™ nhá»› mÃ  chÃºng ta sáº½ leak lÃ  tá»« cÃ¡c láº§n phÃ¢n bá»• trÆ°á»›c trong NonPagedPoolNx vÃ  vÃ¬ chÃºng ta cÃ³ thá»ƒ kiá»ƒm soÃ¡t kÃ­ch thÆ°á»›c phÃ¢n bá»•, chÃºng ta sáº½ kiá»ƒm soÃ¡t Ä‘Æ°á»£c dá»¯ liá»‡u mÃ  chÃºng ta sáº½ leak á»Ÿ má»™t má»©c Ä‘á»™ nÃ o Ä‘Ã³.

[SMBleed POC Source Code](https://github.com/ZecOps/CVE-2020-1206-POC)

Váº­y náº¿u khÃ´ng cÃ³ thÃ´ng tin xÃ¡c thá»±c thÃ¬ cÃ³ thá»ƒ leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ kernel khÃ´ng? Äá»ƒ tráº£ lá»i cho cÃ¢u há»i nÃ y, ta hÃ£y phÃ¢n tÃ­ch SMB sÃ¢u hÆ¡n ná»¯a.

# Äi sÃ¢u vÃ o SMB
Khi xÃ¡c thá»±c thÃ´ng tin, client sáº½ gá»­i cÃ¡c message sau: 

`SMB2 NEGOTIATE â†’ SMB2 SESSION_SETUP â†’ SMB2 SESSION_SETUP`

Náº¿u thÃ´ng tin xÃ¡c thá»±c sai, phiÃªn káº¿t ná»‘i sáº½ bá»‹ há»§y sau gÃ³i tin `SMB2 SESSION_SETUP` thá»© 2:

![](pic/pic3.png)

Giáº£ sá»­ ráº±ng ta khÃ´ng cÃ³ thÃ´ng tin xÃ¡c thá»±c, chÃºng ta sáº½ kiá»ƒm tra xem liá»‡u cÃ³ má»™t lá»‡nh nÃ o cÃ³ thá»ƒ gá»­i mÃ  khÃ´ng cáº§n pháº£i xÃ¡c thá»±c hay khÃ´ng. Qua viá»‡c tÃ¬m kiáº¿m, ta nháº­n tháº¥y:
- Lá»‡nh Ä‘áº§u tiá»n pháº£i gá»­i lÃ  `SMB2 NEGOTIATE` vÃ  nÃ³ cÅ©ng lÃ  lá»‡nh `SMB2 NEGOTIATE` duy nháº¥t trong suá»‘t má»™t phiÃªn.
- CÃ¡c lá»‡nh tiáº¿p theo, cho Ä‘áº¿n khi xÃ¡c thá»±c thÃ nh cÃ´ng pháº£i lÃ  `SMB2 SESSION_SETUP`.

Trong Ä‘Ã³ `SMB2 NEGOTIATE` message sáº½ khÃ´ng Ä‘Æ°á»£c nÃ©n. Bug náº±m á»Ÿ hÃ m giáº£i nÃ©n, vÃ¬ váº­y ta sáº½ khÃ´ng xem xÃ©t nÃ³ mÃ  chá»‰ xÃ©t cÃ¡c `SMB2 SESSION_SETUP` message.

## SMB2 SESSION_SETUP
NhÆ° Ä‘Ã£ nÃ³i á»Ÿ trÃªn, má»™t phiÃªn thÃ´ng thÆ°á»ng sáº½ cÃ³ 2 lá»‡nh SMB2 SESSION_SETUP Ä‘Æ°á»£c gá»­i. CÃ¡c gÃ³i tin tráº£ vá» sáº½ khÃ´ng chá»©a dá»¯ liá»‡u nÃ o cáº§n thiáº¿t Ä‘á»ƒ ta cÃ³ thá»ƒ khai thÃ¡c, vÃ  ta cÅ©ng khÃ´ng cÃ³ cÃ¡ch nÃ o lÃ m áº£nh hÆ°á»Ÿng Ä‘áº¿n gÃ³i tin tráº£ vá». Tuy nhiÃªn gÃ³i tráº£ vá» thá»© hai sáº½ cÃ³ body trá»‘ng vá»›i status 0xC000006D (STATUS_LOGON_FAILURE) trong packet header. Nháº­n tháº¥y, gÃ³i SMB2 SESSION_SETUP Ä‘áº§u tiÃªn sáº½ chá»©a request [NTLM Negotiate message](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/b34032e5-3aae-4bc6-84c3-c6d80eadf7f2) vÃ  gÃ³i thá»© 2 sáº½ chá»©a [NTLM Authenticate message](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/033d32cc-88f9-4483-9bf2-b273055038ce). NTLM Negotiate message khÃ¡ Ä‘Æ¡n giáº£n, vÃ  cÃ³ thá»ƒ khÃ´ng cÃ³ gÃ¬ thÃº vá»‹, nÃªn ta sáº½ Ä‘i sÃ¢u vÃ o NTLM Authenticate message.

### NTLM Authenticate message
Sau khi nghiÃªn cá»©u NTLM Authenticate message, ta nháº­n tháº¥y, pháº§n phá»©c táº¡p nháº¥t cá»§a message nÃ y, thÃ­ch há»£p Ä‘á»ƒ khai thÃ¡c nháº¥t lÃ  cáº¥u trÃºc [NTLM2 V2 Response](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/d43e2224-6fc3-449d-9f37-b90b55a29c80). Cáº¥u trÃºc nÃ y lÃ  má»™t máº£ng byte cÃ³ kÃ­ch thÆ°á»›c khÃ´ng cá»‘ Ä‘á»‹nh, chá»§ yáº¿u chá»©a cáº¥u trÃºc [NTLMv2_CLIENT_CHALLENGE](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/aee311d6-21a7-4470-92a5-c4ecb022a87b). Ta tháº¥y ráº±ng, náº¿u cáº¥u trÃºc nÃ y khÃ´ng pass Ä‘Æ°á»£c cÃ¡c kiá»ƒm tra ban Ä‘áº§u, giÃ¡ trá»‹ 0xC000000D (STATUS_INVALID_PARAMETER) sáº½ Ä‘Æ°á»£c tráº£ vá» thay vÃ¬ 0xC000006D (STATUS_LOGON_FAILURE). Má»™t trong sá»‘ kiá»ƒm tra ban Ä‘áº§u lÃ  kiá»ƒm tra trÆ°á»ng AvPairs.

TrÆ°á»ng AvPairs lÃ  má»™t máº£ng byte cÃ³ kÃ­ch thÆ°á»›c khÃ´ng cá»‘ Ä‘á»‹nh chá»©a cÃ¡c cáº¥u trÃºc [AV_PAIR](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/83f5e789-660d-4781-8491-5f8c6641f75e). Má»—i AV_PAIR Ä‘á»‹nh nghÄ©a má»™t attribute/value pair, attribute Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a bá»Ÿi trÆ°á»ng AvId, trÆ°á»ng AvLen Ä‘á»‹nh nghÄ©a Ä‘á»™ dÃ i theo byte cá»§a value, trÆ°á»ng Value lÃ  má»™t máº£ng byte cÃ³ kÃ­ch thÆ°á»›c khÃ´ng cá»‘ Ä‘á»‹nh chá»©a value cá»§a chÃ­nh nÃ³. Má»™t item vá»›i attribute MsvAvEOL vÃ  má»™t zero length Ä‘Ã¡nh dáº¥u káº¿t thÃºc máº£ng

![](pic/pic4.png)

Authenticate message Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi hÃ m SsprHandleAuthenticateMessage trong module msv1_0.dll. Trong cÃ¡c láº§n kiá»ƒm tra ban Ä‘áº§u, hÃ m nÃ y báº£o Ä‘áº£m ráº±ng, máº£ng AvPairs sáº½ chá»©a cÃ¡c attribute sau: 0x0001 (MsvAvNbComputerName), 0x0002 (MsvAvNbDomainName). Tuy nhiÃªn value cá»§a nÃ³ khÃ´ng Ä‘Æ°á»£c kiá»ƒm tra, nÃ³ chá»‰ kiá»ƒm tra báº±ng cÃ¡ch duyá»‡t qua máº£ng vÃ  kiá»ƒm tra xem attribute Ä‘Æ°á»£c yÃªu cáº§u cÃ³ tá»“n táº¡i hay khÃ´ng vÃ  Ä‘á»™ dÃ i cá»§a nÃ³ cÃ³ náº±m trong cáº¥u trÃºc hay khÃ´ng. Náº¿u Ä‘á»™ dÃ i quÃ¡ lá»›n, viá»‡c truyá»n táº£i sáº½ bá»‹ dá»«ng láº¡i. VÃ¬ váº­y, trÃªn thá»±c táº¿, MsvAvEOL khÃ´ng Ä‘Æ°á»£c kiá»ƒm tra cÃ³ há»£p lá»‡ hay khÃ´ng.

Táº¡i thá»i Ä‘iá»ƒm nÃ y, ta Ä‘Ã£ tÃ¬m ra ráº±ng ta cÃ³ thá»ƒ táº¡o ra má»™t yÃªu cáº§u cÃ³ thá»ƒ giÃºp ta tráº£ lá»i cho cÃ¢u há»i sau: Cho hai byte táº¡i offset x, thuá»™c kiá»ƒu uint16, giÃ¡ trá»‹ cÃ³ lá»›n hÆ¡n y khÃ´ng? x vÃ  y Ä‘Æ°á»£c kiá»ƒm soÃ¡t bá»Ÿi ta. HÃ£y xem xÃ©t gÃ³i tin sau:

![](pic/pic5.png)

Ná»™i dung cá»§a value 0x0001 (MsvAvNbComputerName) khÃ´ng quan trá»ng, vÃ¬ váº­y ta cÃ³ thá»ƒ sá»­ dá»¥ng nÃ³ Ä‘á»ƒ Ä‘iá»u chá»‰nh offset cá»§a value thá»© hai. Äá»‘i vá»›i value thá»© hai, ta chá»‰ set attribute lÃ  0x0002 (MsvAvNbDomainName), mÃ  khÃ´ng khá»Ÿi táº¡o len vÃ  value. Äá»“ng thá»i set kÃ­ch thÆ°á»›c cá»§a toÃ n bá»™ gÃ³i sao cho cÃ³ y byte theo trÆ°á»ng length. CÃ³ hai káº¿t quáº£ cÃ³ thá»ƒ xáº£y ra tÃ¹y thuá»™c vÃ o giÃ¡ trá»‹ chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o cá»§a trÆ°á»ng length cá»§a value thá»© hai:

- length <= y: Trong trÆ°á»ng há»£p nÃ y, kiá»ƒm tra Ä‘Æ°á»£c pass vÃ¬ giÃ¡ trá»‹ 0x0002 há»£p lá»‡ (MsvAvNbDomainName) Ä‘Æ°á»£c tÃ¬m tháº¥y. MÃ¡y chá»§ tráº£ vá» 0xC000006D (STATUS_LOGON_FAILURE) vÃ¬ thÃ´ng tin xÃ¡c thá»±c khÃ´ng chÃ­nh xÃ¡c.
- length > y: Trong trÆ°á»ng há»£p nÃ y, viá»‡c kiá»ƒm tra khÃ´ng thÃ nh cÃ´ng, vÃ¬ giÃ¡ trá»‹ thá»© hai cÃ³ Ä‘á»™ dÃ i khÃ´ng há»£p lá»‡ vÃ  bá»‹ loáº¡i bá». MÃ¡y chá»§ tráº£ vá» 0xC000000D (STATUS_INVALID_PARAMETER) cho trÆ°á»ng há»£p nÃ y.

Theo pháº£n há»“i tá»« server, ta luÃ´n cÃ³ thá»ƒ suy ra cÃ¢u tráº£ lá»i cho cÃ¢u há»i á»Ÿ trÃªn.

Tuy nhiÃªn, NTLM Authenticate message Ä‘Æ°á»£c giá»›i háº¡n á»Ÿ 0xB48 byte vÃ  sáº½ bá»‹ loáº¡i bá» náº¿u nÃ³ lá»›n hÆ¡n tháº¿. Viá»‡c kiá»ƒm tra Ä‘Æ°á»£c thá»±c hiá»‡n bá»Ÿi hÃ m SspContextGetMessage [](SpLsaModeInitialize-->NtLmFunctionTable.SpAcceptLsaModeContext-->SsprHandleAuthenticateMessage-->SspContextGetMessage)trong msv1_0.dll module. Váº­y giáº£ sá»­ ta chá»‰ ghi vÃ o 1 byte len, byte cÃ²n láº¡i sáº½ chá»©a giÃ¡ trá»‹ chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o, thÃ¬ cÃ³ bypass Ä‘Æ°á»£c viá»‡c nÃ y khÃ´ng. Ráº¥t tiáº¿c lÃ  khÃ´ng, vÃ¬ giÃ¡ trá»‹ uint16 Ä‘Æ°á»£c mÃ£ hÃ³a dÆ°á»›i dáº¡ng little endian.
NhÆ° váº­y, ta KhÃ´ng thá»ƒ Ä‘áº¡t Ä‘Æ°á»£c Ä‘iá»u mÃ¬nh muá»‘n trong má»™t phiÃªn SMB duy nháº¥t, ta sáº½ Ä‘i xem xÃ©t thÃªm cÃ¡c yáº¿u tá»‘ khÃ¡c.

## Observation #1: Lookaside lists
NhÆ° Ä‘Ã£ Ä‘á» cáº­p trong nghiÃªn cá»©u trÆ°á»›c ([CVE-2020-0796](https://github.com/datntsec/CVE-2020-0796)), cÃ¡c modules xá»­ lÃ½ SMB trong kernel (srv2.sys vÃ  srvnet.sys) sá»­ dá»¥ng chá»©c nÄƒng phÃ¢n bá»• tÃ¹y chá»‰nh - SrvNetAllocateBuffer - Ä‘Æ°á»£c export bá»Ÿi srvnet.sys. HÃ m nÃ y sá»­ dá»¥ng lookaside lists cho cÃ¡c phÃ¢n bá»• nhá» Ä‘á»ƒ tá»‘i Æ°u hÃ³a. Lookaside lists Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÆ°u trá»¯ má»™t cÃ¡ch hiá»‡u quáº£ má»™t táº­p há»£p cÃ¡c bá»™ Ä‘á»‡m cÃ³ kÃ­ch thÆ°á»›c cá»‘ Ä‘á»‹nh, cÃ³ thá»ƒ tÃ¡i sá»­ dá»¥ng cho trÃ¬nh Ä‘iá»u khiá»ƒn.

Lookaside lists Ä‘Æ°á»£c táº¡o khi khá»Ÿi táº¡o, danh sÃ¡ch cho tá»«ng kÃ­ch thÆ°á»›c vÃ  bá»™ xá»­ lÃ½ logic Ä‘Æ°á»£c mÃ´ táº£ trong báº£ng sau:

| â†’ Allocation size â†“Logical Processor | 0x1100   |  0x2100  |  0x4100  |  0x8100  | 0x10100  |  0x20100 | 0x40100  | 0x80100  | 0x100100 |
|--------------------------------------|----------|----------|----------|----------|----------|----------|----------|----------|----------|
|              Processor 1             |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |
|              Processor 2             |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |
|                 ...                  |          |          |          |          |          |          |          |          |          |
|              Processor n             |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |     ğŸ“    |

Má»—i Ã´ cÃ³ kÃ½ hiá»‡u "ğŸ“" lÃ  má»™t lookaside list riÃªng biá»‡t. Äá»ƒ Ä‘Æ¡n giáº£n hÃ³a phÃ¢n tÃ­ch, ta sáº½ giáº£ sá»­ ráº±ng má»¥c tiÃªu cá»§a chÃºng ta chá»‰ cÃ³ má»™t Logical Processor. Trong trÆ°á»ng há»£p nÃ y, miá»…n lÃ  cÃ¹ng má»™t lÆ°á»£ng byte Ä‘Æ°á»£c cáº¥p phÃ¡t, cÃ¹ng má»™t lookaside list Ä‘Æ°á»£c sá»­ dá»¥ng thÃ¬ cÅ©ng sáº½ cÃ¹ng má»™t buffer Ä‘Æ°á»£c sá»­ dá»¥ng láº¡i nhiá»u láº§n. Ta cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘iá»u nÃ y Ä‘á»ƒ cÃ³ má»™t sá»‘ quyá»n kiá»ƒm soÃ¡t Ä‘á»‘i vá»›i dá»¯ liá»‡u chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o.

## Observation #2: Failing the decompression
HÃ£y xem láº¡i Ä‘iá»u gÃ¬ sáº½ xáº£y ra khi má»™t compressed packet Ä‘Æ°á»£c decompress (tham kháº£o writeup [CVE-2020-0796](https://github.com/datntsec/CVE-2020-0796) Ä‘á»ƒ biáº¿t thÃªm chi tiáº¿t vÃ  mÃ£ giáº£):

![](pic/pic6.png)

Trong trÆ°á»ng há»£p CompressedData khÃ´ng há»£p lá»‡, giai Ä‘oáº¡n decompression sáº½ khÃ´ng thÃ nh cÃ´ng, giai Ä‘oáº¡n copy khÃ´ng Ä‘Æ°á»£c thá»±c thi vÃ  káº¿t ná»‘i bá»‹ ngáº¯t. NhÆ°ng decompression cÃ³ thá»ƒ khÃ´ng thÃ nh cÃ´ng chá»‰ sau khi giáº£i nÃ©n má»™t pháº§n cá»§a CompressedData há»£p lá»‡. Äiá»u nÃ y cho phÃ©p ta táº¡o ra má»™t yÃªu cáº§u sao cho dá»¯ liá»‡u mÃ  ta lá»±a chá»n sáº½ Ä‘Æ°á»£c ghi á»Ÿ offset mÃ  ta lá»±a chá»n, nhÆ° hÃ¬nh sau:

![](pic/pic7.png)

## Back to the NTLM Authenticate message
Ta cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡c Observation trÃªn Ä‘á»ƒ lÃ m cho ká»¹ thuáº­t cá»§a ta hoáº¡t Ä‘á»™ng báº±ng cÃ¡ch sá»­ dá»¥ng hai bÆ°á»›c:
1. Gá»­i má»™t message vá»›i má»™t compressed data khÃ´ng há»£p lá»‡ Ä‘á»ƒ chá»‰ má»™t byte 0 duy nháº¥t Ä‘Æ°á»£c giáº£i nÃ©n. Byte Ä‘Ã³ sáº½ lÃ  byte thá»© nháº¥t cá»§a trÆ°á»ng length cá»§a Value thá»© hai trong máº£ng AvPairs.
2. Gá»­i má»™t message giá»‘ng nhÆ° trÆ°á»›c Ä‘Ã¢y, nhÆ°ng Ä‘áº£m báº£o ráº±ng cÃ¹ng má»™t lookaside list Ä‘Æ°á»£c sá»­ dá»¥ng cho viá»‡c phÃ¢n bá»•, sao cho byte 0 sáº½ á»Ÿ Ä‘Ã³.

![](pic/pic8.png)

Láº§n nÃ y, ká»¹ thuáº­t nÃ y cÃ³ thá»ƒ tráº£ lá»i cÃ¢u há»i sau: Cho má»™t byte á»Ÿ offset x, giÃ¡ trá»‹ cÃ³ lá»›n hÆ¡n y khÃ´ng? NhÆ° trÆ°á»›c Ä‘Ã¢y, x vÃ  y Ä‘Æ°á»£c kiá»ƒm soÃ¡t bá»Ÿi ta.

VÃ¬ ta cÃ³ thá»ƒ sá»­ dá»¥ng láº¡i bá»™ Ä‘á»‡m nhiá»u láº§n báº±ng cÃ¡ch Ä‘áº£m báº£o sá»­ dá»¥ng cÃ¹ng má»™t lookaside list, chÃºng ta cÃ³ thá»ƒ láº·p láº¡i cÃ¡c bÆ°á»›c nhiá»u láº§n trong khi thay Ä‘á»•i y vÃ  cuá»‘i cÃ¹ng suy ra giÃ¡ trá»‹ byte táº¡i má»™t khoáº£ng chÃªnh lá»‡ch nháº¥t Ä‘á»‹nh.

Tuy nhiÃªn, ká»¹ thuáº­t nÃ y cÃ³ má»™t háº¡n cháº¿ - offset cá»§a byte mÃ  chÃºng ta cÃ³ thá»ƒ Ä‘á»c Ä‘Æ°á»£c giá»›i háº¡n á»Ÿ byte 0xADB tá»« Ä‘áº§u cá»§a packet buffer. ÄÃ³ lÃ  do offset cá»§a NTLM Authenticate message (AUTHENTICATE_MESSAGE) Ä‘Æ°á»£c giá»›i háº¡n á»Ÿ 0x40 byte sau khi káº¿t thÃºc SMB2 SESSION_SETUP headers (Ä‘Æ°á»£c thá»±c thi bá»Ÿi hÃ m Smb2ValidateSessionSetup trong srv2.sys) vÃ  kÃ­ch thÆ°á»›c cá»§a NTLM Authenticate message (AUTHENTICATE_MESSAGE) bá»‹ giá»›i háº¡n thÃ nh 0xB48 byte. Ta sáº½ tÃ¬m cÃ¡ch giáº£i quyáº¿t viá»‡c nÃ y.

Giáº£ sá»­ ráº±ng ta muá»‘n Ä‘á»c má»™t byte á»Ÿ offset 0x1100. Ta khÃ´ng thá»ƒ lÃ m Ä‘iá»u Ä‘Ã³ trá»±c tiáº¿p báº±ng ká»¹ thuáº­t trÃªn, tuy nhiÃªn ta váº«n cÃ³ thá»ƒ sá»­ dá»¥ng thÃªm kÄ© thuáº­t sau: vÃ¬ cÃ¡c buffer Ä‘Æ°á»£c tÃ¡i sá»­ dá»¥ng tá»« lookaside lists, ta cÃ³ thá»ƒ "nÃ¢ng" byte Ä‘Ã­ch thÃ´ng qua hÃ m decompression báº±ng cÃ¡ch Ä‘áº·t trÆ°á»ng Offset Ä‘á»ƒ vÆ°á»£t qua byte Ä‘Ã³. Ta chá»‰ cáº§n Ä‘áº£m báº£o ráº±ng dá»¯ liá»‡u náº±m á»Ÿ Ä‘Ã³ cÃ³ thá»ƒ Ä‘Æ°á»£c hiá»ƒu lÃ  dá»¯ liá»‡u nÃ©n há»£p lá»‡, náº¿u khÃ´ng viá»‡c Copy sáº½ khÃ´ng xáº£y ra.

![](pic/pic9.png)

Buffer cá»§a gÃ³i tin chá»©a dá»¯ liá»‡u Ä‘Æ°á»£c gá»­i Ä‘áº¿n bá»Ÿi client sáº½ chá»©a thÃªm 16 byte headers khÃ´ng Ä‘Æ°á»£c copy khi quÃ¡ trÃ¬nh giáº£i nÃ©n diá»…n ra. Káº¿t quáº£ lÃ , dá»¯ liá»‡u Ä‘Æ°á»£c copy vÃ  giáº£i nÃ©n, bao gá»“m cáº£ target byte, Ä‘Æ°á»£c sao chÃ©p Ä‘áº¿n má»™t vá»‹ trÃ­ gáº§n 16 byte hÆ¡n pháº§n Ä‘áº§u cá»§a buffer Ä‘Æ°á»£c cáº¥p phÃ¡t. ChÃºng ta cÃ³ thá»ƒ láº·p láº¡i Ä‘iá»u Ä‘Ã³ vÃ i láº§n, cho Ä‘áº¿n khi offset cá»§a target byte Ä‘á»§ tháº¥p. 

## Address leak POC
Báº¡n cÃ³ thá»ƒ tÃ¬m tháº¥y má»™t script chá»©ng minh ká»¹ thuáº­t trÃªn [táº¡i Ä‘Ã¢y](https://github.com/ZecOps/CVE-2020-0796-RCE-POC/blob/793b9360347b40341c5128bf9723edbd7c492b24/leak_pool_address.py). HÃ£y nhá»› ráº±ng ta Ä‘Ã£ giáº£ Ä‘á»‹nh ráº±ng mÃ¡y tÃ­nh server chá»‰ cÃ³ má»™t bá»™ xá»­ lÃ½ logic, vÃ¬ váº­y báº¡n sáº½ pháº£i Ä‘á»‹nh cáº¥u hÃ¬nh mÃ¡y áº£o cá»§a mÃ¬nh Ä‘Ãºng cÃ¡ch Ä‘á»ƒ Ä‘oáº¡n script hoáº¡t Ä‘á»™ng. Náº¿u má»i viá»‡c suÃ´n sáº», Ä‘oáº¡n script sáº½ Ä‘á»c vÃ  leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a NonPagedPoolNx pool. TrÃªn thá»±c táº¿, Ä‘Ã³ sáº½ lÃ  Ä‘á»‹a chá»‰ cá»§a má»™t trong nhá»¯ng buffer náº±m cÃ¹ng má»™t lookaside lists.

VÃ¬ kÄ© thuáº­t nÃ y cÃ³ khÃ¡ nhiá»u háº¡n cháº¿, nÃªn tÃ´i sáº½ khÃ´ng phÃ¢n tÃ­ch sÃ¢u hÆ¡n ná»¯a. Tuy nhiÃªn báº¡n váº«n cÃ³ thá»ƒ Ä‘á»c script trÃªn vÃ  tá»± phÃ¢n tÃ­ch.

# A different approach â€“ decompression
Trong quÃ¡ trÃ¬nh nghiÃªn cá»©u, [Zecops](https://zecops.com/) nháº­n ra ráº±ng gÃ³i SMB Ä‘Æ°á»£c giáº£i nÃ©n khÃ´ng pháº£i lÃ  cáº¥u trÃºc phá»©c táº¡p duy nháº¥t cÃ³ thá»ƒ khÃ´ng há»£p lá»‡ theo nhiá»u cÃ¡ch khÃ¡c nhau. Ngay cáº£ trÆ°á»›c khi xá»­ lÃ½ táº¥t cáº£ cÃ¡c cáº¥u trÃºc liÃªn quan Ä‘áº¿n SMB, compressed buffer cÅ©ng cÃ³ thá»ƒ khÃ´ng há»£p lá»‡. Náº¿u giáº£i nÃ©n khÃ´ng thÃ nh cÃ´ng, káº¿t ná»‘i Ä‘áº¿n server sáº½ bá»‹ ngáº¯t.

Microsoft cung cáº¥p ba thuáº­t toÃ¡n nÃ©n Ä‘á»ƒ ta lá»±a chá»n khi triá»ƒn khai SMB: LZNT1, Plain LZ77 vÃ  LZ77 + Huffman. Ta sáº½ chá»‰ xem xÃ©t LZNT1 vÃ¬ nÃ³ khÃ¡ Ä‘Æ¡n giáº£n - [khoáº£ng 80 dÃ²ng Python cho má»™t hÃ m giáº£i nÃ©n](https://github.com/MITRECND/chopshop/blob/master/ext_libs/lznt1.py). TÃ´i sáº½ nÃ³i sÆ¡ vá» quÃ¡ trÃ¬nh giáº£i nÃ©n: dá»¯ liá»‡u nÃ©n bao gá»“m má»™t chuá»—i cÃ¡c block Ä‘Æ°á»£c nÃ©n, má»—i block Ä‘Æ°á»£c báº¯t Ä‘áº§u báº±ng má»™t biáº¿n uint16 Ä‘Ã¡nh dáº¥u Ä‘á»™ dÃ i cá»§a block Ä‘Ã³. Khi gáº·p Ä‘á»™ dÃ i báº±ng 0, quÃ¡ trÃ¬nh giáº£i nÃ©n sáº½ hoÃ n táº¥t. Ta sáº½ sá»­ dá»¥ng Ä‘iá»u nÃ y Ä‘á»ƒ ghi vÃ o má»™t chuá»—i byte 0 tÆ°á»£ng trÆ°ng cho dá»¯ liá»‡u nÃ©n há»£p lá»‡. Má»¥c Ä‘Ã­ch Ä‘á»ƒ tráº£ lá»i cho cÃ¢u há»i á»Ÿ trÃªn: Cho má»™t byte á»Ÿ offset x, giÃ¡ trá»‹ cÃ³ lá»›n hÆ¡n y khÃ´ng? Táº¥t nhiÃªn, x vÃ  Ã½ váº«n sáº½ do ta kiá»ƒm soÃ¡t.

DÆ°á»›i Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ vá» dá»¯ liá»‡u nÃ©n mÃ  ta sáº½ gá»­i:

![](pic/pic10.png)

CÃ³ hai káº¿t quáº£ cÃ³ thá»ƒ xáº£y ra tÃ¹y thuá»™c vÃ o giÃ¡ trá»‹ chÆ°a khá»Ÿi táº¡o cá»§a byte thá»© nháº¥t cá»§a trÆ°á»ng length:
- length <= y: Trong trÆ°á»ng há»£p nÃ y, block Ä‘áº§u tiÃªn sáº½ toÃ n byte 0, Ä‘iá»u nÃ y hoÃ n toÃ n há»£p lá»‡ vÃ  length cá»§a block tiáº¿p theo sáº½ báº±ng 0, viá»‡c giáº£i nÃ©n sáº½ hoÃ n táº¥t. Server sáº½ tráº£ láº¡i má»™t response.
- length > y: Trong trÆ°á»ng há»£p nÃ y, block nÃ©n Ä‘áº§u tiÃªn hoáº·c thá»© hai sáº½ chá»©a cÃ¡c byte 0xFF, block nÃ y sáº½ khÃ´ng giáº£i nÃ©n Ä‘Æ°á»£c. Server sáº½ ngáº¯t káº¿t ná»‘i do dá»¯ liá»‡u nÃ©n khÃ´ng há»£p lá»‡.

CÅ©ng giá»‘ng nhÆ° ká»¹ thuáº­t trÆ°á»›c, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡c Observation sá»‘ 1 vÃ  sá»‘ 2 Ä‘á»ƒ táº¡o ra má»™t message vá»›i má»™t byte chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o á»Ÿ giá»¯a message báº±ng cÃ¡ch sá»­ dá»¥ng hai bÆ°á»›c:
1. Gá»­i má»™t message vá»›i dá»¯ liá»‡u nÃ©n khÃ´ng há»£p lá»‡ Ä‘á»ƒ chá»‰ má»™t pháº§n dá»¯ liá»‡u Ä‘Æ°á»£c giáº£i nÃ©n, tÆ°Æ¡ng tá»± nhÆ° hÃ¬nh trÃªn
2. Gá»­i message thá»© hai vÃ  Ä‘áº£m báº£o ráº±ng cÃ¹ng má»™t lookaside list Ä‘Æ°á»£c sá»­ dá»¥ng trong message thá»© 1, Ä‘á»ƒ cÃ¡c byte tá»« bÆ°á»›c 1 sáº½ á»Ÿ Ä‘Ã³.

LÆ°u Ã½ ráº±ng giÃ¡ trá»‹ Offset trong header gÃ³i SMB sáº½ trá» Ä‘áº¿n dá»¯ liá»‡u nÃ©n, dá»¯ liá»‡u nÃ y cÃ³ thá»ƒ há»£p lá»‡ hay khÃ´ng tÃ¹y thuá»™c vÃ o giÃ¡ trá»‹ cá»§a byte chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o. 

![](pic/pic11.png)

Æ¯u Ä‘iá»ƒm Ä‘Ã¡ng chÃº Ã½ nháº¥t cá»§a ká»¹ thuáº­t nÃ y so vá»›i ká»¹ thuáº­t trÆ°á»›c lÃ  khÃ´ng cÃ³ giá»›i háº¡n offset ná»¯a.

NhÆ° váº­y, tá»•ng káº¿t láº¡i, ta cÃ³ 2 ká»¹ thuáº­t Ä‘á»ƒ Ä‘á»c má»™t vÃ¹ng nhá»› chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o tá»« pool buffer Ä‘Æ°á»£c cáº¥p phÃ¡t bá»Ÿi hÃ m SrvNetAllocateBuffer cá»§a module srvnet.sys. Ká»¹ thuáº­t Ä‘áº§u tiÃªn táº¡o ra má»™t gÃ³i SMB Ä‘áº·c biá»‡t, sau Ä‘Ã³ suy luáº­n thÃ´ng tin thÃ´ng qua response cá»§a server. Ká»¹ thuáº­t thá»© hai vá»›i Ã­t háº¡n cháº¿ hÆ¡n, ta sáº½ táº¡o ra má»™t dá»¯ liá»‡u Ä‘Æ°á»£c nÃ©n Ä‘áº·c biá»‡t vÃ  gá»­i nÃ³ Ä‘i, sau Ä‘Ã³ suy luáº­n thÃ´ng tin dá»±a trÃªn viá»‡c server cÃ³ ngáº¯t káº¿t nÃ³i hay khÃ´ng.

NhÆ° váº­y, ta cÃ³ thá»ƒ sá»­ dá»¥ng má»™t trong 2 kÄ© thuáº­t trÃªn Ä‘á»ƒ khai thÃ¡c. VÃ  nhÆ° tÃ´i Ä‘Ã£ nÃ³i, kÄ© thuáº­t Ä‘áº§u tiÃªn cÃ³ nhiá»u háº¡n cháº¿, nÃªn ta sáº½ chá»‰ Ä‘i sÃ¢u vÃ o kÄ© thuáº­t thá»© 2.

KÄ© thuáº­t nÃ y sáº½ giÃºp ta khai thÃ¡c theo hÆ°á»›ng write-what-where primitive mÃ  Zecops Ä‘Ã£ chá»©ng minh trÆ°á»›c Ä‘Ã¢y trong [nghiÃªn cá»©u trÆ°á»›c](https://blog.zecops.com/vulnerabilities/exploiting-smbghost-cve-2020-0796-for-a-local-privilege-escalation-writeup-and-poc/) vá» kháº£ nÄƒng Ä‘áº¡t Ä‘Æ°á»£c local privilege escalation. Ta sáº½ dÃ¹ng kÄ© thuáº­t nÃ y Ä‘á»ƒ leak Ä‘á»‹a chá»‰ trong memory layout Ä‘á»ƒ cÃ³ thá»ƒ sá»­ dá»¥ng write-what-where primitive. KhÃ´ng may máº¯n lÃ  memory Ä‘Æ°á»£c cáº¥p phÃ¡t bá»Ÿi hÃ m SrvNetAllocateBuffer chá»§ yáº¿u Ä‘Æ°á»£c sá»­ dá»¥ng cho dá»¯ liá»‡u máº¡ng nhÆ° gÃ³i SMB vÃ  khÃ´ng chá»©a báº¥t ká»³ con trá» system nÃ o. VÃ  vÃ¬ ta cáº§n Ä‘áº¡t Ä‘Æ°á»£c RCE, nÃªn viá»‡c leak cÃ¡c vÃ¹ng nhá»› chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o bá»Ÿi cÃ¡c láº§n cáº¥p phÃ¡t trÆ°á»›c cá»§a hÃ m SrvNetAllocateBuffer lÃ  vÃ´ Ã­ch do khÃ´ng cháº¯c cháº¯n Ä‘Æ°á»£c vá»‹ trÃ­ con trá» cáº§n tÃ¬m. Ta cáº§n tÃ¬m má»™t thá»© gÃ¬ Ä‘Ã³ cÃ³ thá»ƒ há»¯u Ã­ch hÆ¡n.

## SrvNetAllocateBuffer and the allocated buffer layout
NhÆ° tÃ´i cÃ³ nÃ³i trong nghiÃªn cá»©u vá» local privilege escalation ([CVE-2020-0796](https://github.com/datntsec/CVE-2020-0796)), hÃ m SrvNetAllocateBuffer khÃ´ng chá»‰ tráº£ vá» má»™t buffer vá»›i kÃ­ch thÆ°á»›c Ä‘Æ°á»£c yÃªu cáº§u. Thay vÃ o Ä‘Ã³ nÃ³ sáº½ tráº£ vá» má»™t con trá» trá» Ä‘áº¿n vÃ¹ng náº±m ngay bÃªn dÆ°á»›i user buffer cá»§a cáº¥u trÃºc pool-allocated memory block, chá»©a thÃ´ng tin vá» buffer Ä‘Æ°á»£c cáº¥p phÃ¡t. CÃ¡ch bá»‘ trÃ­ cá»§a pool-allocated memory block nhÆ° sau:

![](pic/pic12.png)

Máº·c dÃ¹ ká»¹ thuáº­t Ä‘á»c cá»§a ta chá»‰ cÃ³ thá»ƒ Ä‘á»c cÃ¡c byte tá»« vÃ¹ng "User Buffer", ta váº«n cÃ³ thá»ƒ dÃ¹ng má»™t kÄ© thuáº­t khÃ¡c Ä‘á»ƒ copy cÃ¡c pháº§n cá»§a cáº¥u trÃºc SRVNET_BUFFER_HDR vÃ o "User Buffer" cá»§a má»™t buffer khÃ¡c Ä‘á»ƒ cÃ³ thá»ƒ Ä‘á»c nÃ³. Báº±ng cÃ¡ch Ä‘áº·t trÆ°á»ng Offset trá» Ä‘áº¿n cáº¥u trÃºc SRVNET_BUFFER_HDR náº±m ngoÃ i dá»¯ lá»‡u mÃ  ta muá»‘n Ä‘á»c. Ta chá»‰ cáº§n Ä‘áº£m báº£o ráº±ng dá»¯ liá»‡u náº±m á»Ÿ Ä‘Ã³ cÃ³ thá»ƒ Ä‘Æ°á»£c hiá»ƒu lÃ  dá»¯ liá»‡u nÃ©n há»£p lá»‡, ngÆ°á»£c láº¡i, viá»‡c copy sáº½ khÃ´ng Ä‘Æ°á»£c diá»…n ra.

![](pic/pic13.png)

## Hunting for pointers
HÃ£y xem xÃ©t cÃ¡c trÆ°á»ng cá»§a cáº¥u trÃºc SRVNET_BUFFER_HDR vÃ  â€‹â€‹xem liá»‡u cÃ³ ná»™i dung nÃ o Ä‘Ã¡ng Ä‘á»ƒ ta Ä‘á»c khÃ´ng:

``` c
#pragma pack(push, 1)
struct SRVNET_BUFFER_HDR {
/*00*/  LIST_ENTRY ConnectionBufferList;
/*10*/  WORD BufferFlags; // 0x01 - no transport header, 0x02 - part of a lookaside list
/*12*/  WORD LookasideListIndex; // 0 to 8
/*14*/  WORD LookasideListLogicalProcessor;
/*16*/  WORD TracingDataCount; // 0, 1 or 2, for TracingPtr1/2, TracingUnknown1/2
/*18*/  PBYTE UserBufferPtr;
/*20*/  DWORD UserBufferSizeAllocated;
/*24*/  DWORD UserBufferSizeUsed;
/*28*/  DWORD PoolAllocationSize;
/*2C*/  BYTE unknown1[4];
/*30*/  PBYTE PoolAllocationPtr;
/*38*/  PMDL pMdl1;
/*40*/  DWORD BytesProcessed;
/*44*/  BYTE unknown2[4];
/*48*/  SIZE_T BytesReceived;
/*50*/  PMDL pMdl2;
/*58*/  PVOID pSrvNetWskStruct;
/*60*/  DWORD SmbFlags;
/*64*/  PVOID TracingPtr1;
/*6C*/  SIZE_T TracingUnknown1;
/*74*/  PVOID TracingPtr2;
/*7C*/  SIZE_T TracingUnknown2;
/*84*/  BYTE unknown3[12];
};
#pragma pack(pop)
```

CÃ¡c con trá» `UserBufferPtr`, `PoolAllocationPtr`, `pMdl1`, `pMdl2` lÃ  nhá»¯ng con trá» trá» vÃ o bÃªn trong pool-allocated memory block, vá»›i cÃ¡c offset cÃ³ thá»ƒ Ä‘Æ°á»£c tÃ­nh toÃ¡n trÆ°á»›c, vÃ¬ váº­y ta chá»‰ cáº§n Ä‘á»c má»™t trong sá»‘ chÃºng lÃ  Ä‘Æ°á»£c. Viá»‡c cÃ³ má»™t con trá» trá» Ä‘áº¿n pool-allocated memory block sáº½ cháº¯c cháº¯n giÃºp Ã­ch cho ta trong viá»‡c khai thÃ¡c. NgoÃ i ra cÃ¡c con trá» sau cÅ©ng ráº¥t quan trá»ng:
- **ConnectionBufferList**: Má»™t danh sÃ¡ch liÃªn káº¿t cá»§a táº¥t cÃ¡c buffer Ä‘Æ°á»£c nháº­n nhÆ°ng chÆ°a Ä‘Æ°á»£c xá»­ lÃ½ cá»§a má»™t káº¿t ná»‘i. Pháº§n Ä‘áº§u cá»§a danh sÃ¡ch nÃ y lÃ  má»™t connection object Ä‘Æ°á»£c táº¡o bá»Ÿi hÃ m SrvNetAllocateConnection trong srvnet.sys. Má»™t buffer Ä‘Æ°á»£c thÃªm vÃ o danh sÃ¡ch bá»Ÿi hÃ m SrvNetWskReceiveComplete. Trong trÆ°á»ng há»£p cá»§a ta, sáº½ chá»‰ cÃ³ duy nháº¥t má»™t buffer trong danh sÃ¡ch, vÃ¬ váº­y cáº£ 2 con trá» (Flink vÃ  Blink cá»§a cáº¥u trÃºc LIST_ENTRY) sáº½ cÃ¹ng trá» Ä‘áº¿n Ä‘áº§u danh sÃ¡ch bÃªn trong connection object.
- **pSrvNetWskStruct**: Ban Ä‘áº§u, má»™t con trá» trá» Ä‘áº¿n connection object Ä‘Æ°á»£c Ä‘á» cáº­p á»Ÿ trÃªn. Con trá» Ä‘Æ°á»£c set bá»Ÿi hÃ m SrvNetWskReceiveEvent, nhÆ°ng bá»‹ ghi Ä‘Ã¨ bá»Ÿi hÃ m SrvNetWskReceiveComplete báº±ng con trá» trá» Ä‘áº¿n cáº¥u trÃºc SRVNET_BUFFER_HDR. VÃ¬ váº­y, Ä‘á»c nÃ³ khÃ´ng há»¯u Ã­ch hÆ¡n Ä‘á»c má»™t trong bá»‘n con trá» Ä‘Ã£ nÃ³i á»Ÿ trÃªn. NhÃ¢n tiá»‡n, náº¿u báº¡n tÃ¬m kiáº¿m â€œpSrvNetWskStructâ€, báº¡n sáº½ tháº¥y ráº±ng nÃ³ cÃ³ má»™t vai trÃ² trong viá»‡c khai thÃ¡c EternalBlue.
- **TracingPtr1/2**: CÃ¡c con trá» nÃ y chá»‰ Ä‘Æ°á»£c sá»­ dá»¥ng khi tÃ­nh nÄƒng tracing Ä‘Æ°á»£c kÃ­ch hoáº¡t.

![](pic/pic14.png)

NhÆ° báº¡n cÃ³ thá»ƒ tháº¥y, con trá» há»¯u Ã­ch duy nháº¥t khÃ¡c Ä‘á»ƒ chÃºng ta Ä‘á»c lÃ  má»™t con trá» trong cáº¥u trÃºc ConnectionBufferList. Cáº£ hai con trá» (Blink vÃ  Flink trong cáº¥u trÃºc LIST_ENTRY) Ä‘á»u trá» Ä‘áº¿n connection object. Object nÃ y Ä‘Æ°á»£c Ä‘áº·t tÃªn lÃ  SRVNET_RECV bá»Ÿi nhÃ  nghiÃªn cá»©u EternalBlue, vÃ¬ váº­y ta cÅ©ng sáº½ sá»­ dá»¥ng tÃªn nÃ y.

## Getting a module base address
BÃ¢y giá», chÃºng ta Ä‘Ã£ biáº¿t cÃ¡ch láº¥y hai con trá» - má»™t con trá» trá» tá»›i pool-allocated memory block vÃ  má»™t con trá» trá» tá»›i cáº¥u trÃºc SRVNET_RECV - chÃºng ta cÃ³ thá»ƒ tá»± do sá»­a Ä‘á»•i hai buffers báº±ng cÃ¡ch sá»­ dá»¥ng write-what-where primitive. CÃ³ thá»ƒ sáº½ cÃ³ nhiá»u cÃ¡ch Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c RCE, nhÆ°ng viá»‡c láº¥y má»™t base address cá»§a má»™t module sáº½ lÃ  lá»±a chá»n Ä‘Æ¡n giáº£n nháº¥t vÃ¬ cÃ³ ráº¥t nhiá»u thá»© tá»« chÃºng mÃ  ta cÃ³ thá»ƒ sá»­a Ä‘á»•i trong data section cá»§a má»™t module. NhÆ° chÃºng ta Ä‘Ã£ tháº¥y, khÃ´ng cÃ³ má»™t con trá» nÃ o trong memory block Ä‘Æ°á»£c cáº¥p phÃ¡t bá»Ÿi SrvNetAllocateBuffer trá» Ä‘áº¿n má»™t module. Tuy nhiÃªn, váº«n cÃ³ má»™t sá»‘ con trá» trá» Ä‘áº¿n cÃ¡c module:

![](pic/pic15.png)

KÄ© thuáº­t Ä‘á»c mÃ  ta cÃ³ chá»‰ cho phÃ©p ta Ä‘á»c Ä‘Æ°á»£c dá»¯ liá»‡u á»Ÿ vÃ¹ng "User Buffer", trong khi Ä‘Ã³ cÃ¡c con trá» nÃ y láº¡i á»Ÿ khÃ¡ xa vÃ  Ä‘Æ°á»£c trá» bá»Ÿi khÃ¡ nhiá»u con trá» khÃ¡c. Ta cáº§n má»™t Ä‘oáº¡n code cÃ³ thá»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u sau Ä‘á»ƒ copy giÃ¡ trá»‹ con trá» vÃ o vÃ¹ng "User Buffer":

``` c
ptr1 = *(pSrvNetRecv + offset1)
value = *ptr1
ptr2 = *(pSrvNetRecv + offset2)
*ptr2 = value
```

Náº¿u ta cÃ³ thá»ƒ tÃ¬m tháº¥y má»™t Ä‘oáº¡n mÃ£ nhÆ° váº­y, ta sáº½ kÃ­ch hoáº¡t nÃ³ Ä‘á»ƒ sao chÃ©p con trá» Ä‘áº§u tiÃªn (vÃ­ dá»¥: HandlerFunctions) vÃ o vÃ¹ng "User Buffer", Ä‘á»c nÃ³, sau Ä‘Ã³ sao chÃ©p con trá» thá»© hai (vÃ­ dá»¥: con trá» hÃ m Srv2ConnectHandler) vÃ o "User Buffer" vÃ  Ä‘á»c nÃ³, suy ra module base address tá»« nÃ³. NhÃ³m [Zecops](https://www.zecops.com/) Ä‘Ã£ tÃ¬m kiáº¿m má»™t Ä‘oáº¡n mÃ£ nhÆ° váº­y trong má»™t thá»i gian dÃ i, nhÆ°ng khÃ´ng tÃ¬m tháº¥y má»™t Ä‘oáº¡n mÃ£ phÃ¹ há»£p nÃ o. Cuá»‘i cÃ¹ng, há» sá»­ dá»¥ng lá»±a chá»n khÃ¡c liÃªn quan Ä‘áº¿n hÃ m SrvNetFreeBuffer (Ä‘Ã£ Ä‘Æ°á»£c Ä‘Æ¡n giáº£n hÃ³a nhÆ° bÃªn dÆ°á»›i) cÃ³ chá»©c nÄƒng gáº§n nhÆ° mong muá»‘n:

``` c
void SrvNetFreeBuffer(PSRVNET_BUFFER_HDR Buffer)
{
    PMDL pMdl1 = Buffer->pMdl1;
    PMDL pMdl2 = Buffer->pMdl2;
 
    if (pMdl2->MdlFlags & 0x0020) {
        // MDL_PARTIAL_HAS_BEEN_MAPPED flag is set.
        MmUnmapLockedPages(pMdl2->MappedSystemVa, pMdl2);
    }
 
    if (Buffer->BufferFlags & 0x02) {
        if (Buffer->BufferFlags & 0x01) {
            pMdl1->MappedSystemVa = (BYTE*)pMdl1->MappedSystemVa + 0x50;
            pMdl1->ByteCount -= 0x50;
            pMdl1->ByteOffset += 0x50;
            pMdl1->MdlFlags |= 0x1000; // MDL_NETWORK_HEADER
 
            pMdl2->StartVa = (PVOID)((ULONG_PTR)pMdl1->MappedSystemVa & ~0xFFF);
            pMdl2->ByteCount = pMdl1->ByteCount;
            pMdl2->ByteOffset = pMdl1->MappedSystemVa & 0xFFF;
            pMdl2->Size = /* some calculation */;
            pMdl2->MdlFlags = 0x0004; // MDL_SOURCE_IS_NONPAGED_POOL
        }
 
        Buffer->BufferFlags = 0;
 
        // ...
 
        pMdl1->Next = NULL;
        pMdl2->Next = NULL;
 
        // Return the buffer to the lookaside list.
    } else {
        SrvNetUpdateMemStatistics(NonPagedPoolNx, Buffer->PoolAllocationSize, FALSE);
        ExFreePoolWithTag(Buffer->PoolAllocationPtr, '00SL');
    }
}
```

Khi giáº£i phÃ³ng bá»™ Ä‘á»‡m, náº¿u buffer flags lÃ  0x02 (cÃ³ nghÄ©a lÃ  buffer lÃ  má»™t pháº§n cá»§a má»™t lookaside list) vÃ  0x01 (cÃ³ nghÄ©a lÃ  buffer khÃ´ng cÃ³ transport header) Ä‘Æ°á»£c set, má»™t sá»‘ thao tÃ¡c Ä‘Æ°á»£c thá»±c hiá»‡n trÃªn hai MDL objects Ä‘á»ƒ thÃªm transport header trÆ°á»›c khi set láº¡i cÃ¡c flag vá» 0 vÃ  tráº£ buffer trá»Ÿ láº¡i lookaside list. Náº¿u chÃºng ta xem xÃ©t kÄ© Ä‘áº±ng sau cÃ¡c thao tÃ¡c trÃªn cÃ¡c MDL object, chÃºng ta cÃ³ thá»ƒ nháº­n tháº¥y ráº±ng Ä‘oáº¡n code thá»±c hiá»‡n phÃ©p double-dereference-read theo sau lÃ   double-dereference-write vá»›i hai biáº¿n mÃ  ta kiá»ƒm soÃ¡t (hai con trá» MDL), Ä‘Ã³ lÃ  nhá»¯ng gÃ¬ ta Ä‘ang tÃ¬m kiáº¿m. NhÆ°á»£c Ä‘iá»ƒm lÃ  ná»™i dung mÃ  chÃºng ta muá»‘n Ä‘á»c cÅ©ng bá»‹ sá»­a Ä‘á»•i, má»™t tÃ¡c dá»¥ng phá»¥ mÃ  ta hy vá»ng cÃ³ thá»ƒ trÃ¡nh Ä‘Æ°á»£c.

Vá»›i nhá»¯ng Ä‘iá»u trÃªn, Ä‘Ã¢y lÃ  cÃ¡ch ta quáº£n lÃ½ Ä‘á»ƒ Ä‘á»c con trá» AcceptSocket:
1. Chuáº©n bá»‹ buffer A tá»« má»™t lookaside list sao cho vÃ¹ng â€œUser bufferâ€ Ä‘Æ°á»£c láº¥p Ä‘áº§y bá»Ÿi cÃ¡c sá»‘ 0. VÃ¹ng user buffer cá»§a buffer nÃ y sáº½ chá»©a con trá» mÃ  chÃºng ta sáº½ Ä‘á»c. 
2. Chuáº©n bá»‹ buffer B tá»« má»™t lookaside list khÃ¡c Ä‘á»ƒ:
- Con trá» pMdl1 trá» Ä‘áº¿n Ä‘á»‹a chá»‰ cá»§a con trá» AcceptSocket trá»« Ä‘i 0x18, (do offset cá»§a MappedSystemVa lÃ  0x18 trong cáº¥u trÃºc MDL).
- Con trá» pMdl2 trá» Ä‘áº¿n vÃ¹ng â€œUser bufferâ€ cá»§a Buffer A.
- TrÆ°á»ng Flags Ä‘Æ°á»£c set thÃ nh 0x03.

Ta cÃ³ thá»ƒ ghi Ä‘Ã¨ cÃ¡c trÆ°á»ng cáº¥u trÃºc SRVNET_BUFFER_HDR báº±ng cÃ¡ch giáº£i nÃ©n chÃºng tá»« buffer lá»›n hÆ¡n thÃ´ng qua ká»¹ thuáº­t Ä‘Æ°á»£c mÃ´ táº£ trong pháº§n [Observation #2](https://github.com/datntsec/CVE-2020-1206#observation-2-failing-the-decompression) á»Ÿ trÃªn.

3. Khi Buffer B Ä‘Æ°á»£c giáº£i phÃ³ng, cÃ¡c hoáº¡t Ä‘á»™ng sau sáº½ diá»…n ra:
- CÃ¡c MDL flags sáº½ Ä‘Æ°á»£c Ä‘á»c tá»« MDL thá»© hai táº¡i buffer A. Náº¿u MDL_PARTIAL_HAS_BEEN_MAPPED flag Ä‘Æ°á»£c set, MmUnmapLockedPages sáº½ Ä‘Æ°á»£c gá»i vÃ  há»‡ thá»‘ng cÃ³ kháº£ nÄƒng bá»‹ crash. ÄÃ³ lÃ  lÃ½ do táº¡i sao ta pháº£i láº¥p Ä‘áº§y buffer báº±ng cÃ¡c sá»‘ 0 á»Ÿ bÆ°á»›c 1.
- Con trá» AcceptSocket vÃ  bá»™ nhá»› xung quanh nÃ³ sáº½ Ä‘Æ°á»£c sá»­a Ä‘á»•i nhÆ° Ä‘Æ°á»£c mÃ´ táº£ á»Ÿ Ä‘Ã¢y:

```
+00 |  00 00 00 00 00 00 00 00
+08 |  __ __ __|10 __ __ __ __
+10 |  __ __ __ __ __ __ __ __
+18 |  [+50..................]  <--  AcceptSocket
+20 |  __ __ __ __ __ __ __ __
+28 |  [-50......] [+50......]
```

- Con trá» AcceptSocket vÃ  bá»™ nhá»› xung quanh nÃ³ sáº½ Ä‘Æ°á»£c Ä‘á»c nhÆ° mÃ´ táº£ á»Ÿ Ä‘Ã¢y:
```
+00 |  __ __ __ __ __ __ __ __
+08 |  __ __ __ __ __ __ __ __
+10 |  __ __ __ __ __ __ __ __
+18 |  ab cd ef gh ij kl mn op  <--  AcceptSocket
+20 |  __ __ __ __ __ __ __ __
+28 |  qr st uv wx __ __ __ __
```

- VÃ¹ng â€œUser bufferâ€ cá»§a buffer A sáº½ Ä‘Æ°á»£c sá»­a Ä‘á»•i nhÆ° Ä‘Æ°á»£c mÃ´ táº£ á»Ÿ Ä‘Ã¢y: (CÃ¡c byte mÃ u cam chá»©a con trá» mÃ  chÃºng ta muá»‘n Ä‘á»c, chÃºng ta chá»‰ cáº§n sáº¯p xáº¿p chÃºng Ä‘Ãºng cÃ¡ch)
```
+00 |  00 00 00 00 00 00 00 00
+08 |  ?? ?? 04 00 __ __ __ __
+10 |  __ __ __ __ __ __ __ __
+18 |  __ __ __ __ __ __ __ __
+20 |  00 c0 ef gh ij kl mn op
+28 |  qr st uv wx ab 0d 00 00
```
![](pic/pic16.png)

4. Äá»c con trá» AcceptSocket tá»« vÃ¹ng â€œUser bufferâ€ cá»§a buffer A.

Tin tá»‘t lÃ  ta Ä‘Ã£ Ä‘á»c Ä‘Æ°á»£c con trá». Tin xáº¥u lÃ  ta Ä‘Ã£ lÃ m há»ng má»™t sá»‘ dá»¯ liá»‡u trong cáº¥u trÃºc SRVNET_RECV. May máº¯n cho ta, lá»—i khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n há»‡ thá»‘ng miá»…n lÃ  khÃ´ng cÃ³ gÃ¬ xáº£y ra vá»›i káº¿t ná»‘i cÃ³ liÃªn quan. Khi Ä‘iá»u gÃ¬ Ä‘Ã³ xáº£y ra, vÃ­ dá»¥: Ä‘Ã³ng káº¿t ná»‘i, há»‡ thá»‘ng sáº½ bá»‹ crash. ÄÃ³ khÃ´ng pháº£i lÃ  váº¥n Ä‘á» vÃ¬ ta sáº½ sá»›m cÃ³ RCE vÃ  ta cÃ³ thá»ƒ sá»­a lá»—i náº¿u ta muá»‘n.

Sau khi Ä‘á»c con trá» AcceptSocket, ta tiáº¿p tá»¥c sá»­ dá»¥ng ká»¹ thuáº­t tÆ°Æ¡ng tá»± Ä‘á»ƒ Ä‘á»c con trá» srvnet!SrvNetWskConnDispatch. LÃ½ do ta Ä‘á»c con trá» AcceptSocket mÃ  khÃ´ng pháº£i con trá» HandlerFunctions lÃ  vÃ¬ máº£ng cá»§a HandlerFunctions Ä‘Æ°á»£c chia sáº» giá»¯a táº¥t cáº£ cÃ¡c káº¿t ná»‘i, trong khi buffer Ä‘Æ°á»£c trá» bá»Ÿi AcceptSocket khÃ´ng Ä‘Æ°á»£c chia sáº» vá»›i cÃ¡c káº¿t ná»‘i khÃ¡c. Do Ä‘Ã³, náº¿u ta lÃ m há»ng cÃ¡c pháº§n trong AcceptSocket, nÃ³ sáº½ chá»‰ áº£nh hÆ°á»Ÿng Ä‘áº¿n sá»± á»•n Ä‘á»‹nh cá»§a má»™t káº¿t ná»‘i.

Náº¿u ta cÃ³ báº£n sao cá»§a tá»‡p srvnet.sys Ä‘Æ°á»£c sá»­ dá»¥ng trÃªn mÃ¡y tÃ­nh target, ta cÃ³ thá»ƒ dá»… dÃ ng suy ra base address cá»§a module srvnet.sys báº±ng cÃ¡ch trá»« Ä‘i offset cá»§a con trá» SrvNetWskConnDispatch mÃ  chÃºng ta Ä‘Ã£ leak Ä‘Æ°á»£c. 

## Implementing arbitrary read
Giáº£ sá»­ ráº±ng ta cÃ³ base address cá»§a module srvnet.sys, ta cÃ³ thá»ƒ gá»i báº¥t ká»³ hÃ m nÃ o cá»§a module. NhÆ°ng cÃ²n cÃ¡c Ä‘á»‘i sá»‘ cá»§a hÃ m thÃ¬ sao? HÃ m srv2!Srv2ReceiveHandler Ä‘Æ°á»£c gá»i bá»Ÿi SrvNetCommonReceiveHandler vÃ  lá»‡nh gá»i cÃ³ dáº¡ng nhÆ° sau:

``` c
HandlerFunctions = *(pSrvNetRecv + 0x118);
Arg1 = *(ULONG_PTR)(pSrvNetRecv + 0x128);
Arg2 = *(ULONG_PTR)(pSrvNetRecv + 0x130);
(HandlerFunctions[1])(Arg1, Arg2, Arg3, Arg4, Arg5, Arg6, Arg7, Arg8);
```

Hai Ä‘á»‘i sá»‘ Ä‘áº§u tiÃªn Ä‘Æ°á»£c Ä‘á»c tá»« cáº¥u trÃºc SRVNET_RECV, vÃ¬ váº­y ta cÃ³ thá»ƒ kiá»ƒm soÃ¡t chÃºng, tuy nhiÃªn ta khÃ´ng thá»ƒ kiá»ƒm soÃ¡t cÃ¡c Ä‘á»‘i sá»‘ cÃ²n láº¡i. Quy Æ°á»›c gá»i x86-64 chá»‰ Ä‘á»‹nh ráº±ng ngÆ°á»i gá»i cÃ³ trÃ¡ch nhiá»‡m phÃ¢n bá»• vÃ  giáº£i phÃ³ng khÃ´ng gian ngÄƒn xáº¿p cho cÃ¡c Ä‘á»‘i sá»‘, vÃ¬ váº­y máº·c dÃ¹ hÃ m 8 Ä‘á»‘i sá»‘ Ä‘Æ°á»£c dá»± Ä‘á»‹nh gá»i, chÃºng ta cÃ³ thá»ƒ thay tháº¿ con trá» báº±ng má»™t hÃ m mong Ä‘á»£i báº¥t ká»³ khÃ¡c.

![](pic/pic17.png)

DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c bÆ°á»›c chÃºng ta sáº½ sá»­ dá»¥ng Ä‘á»ƒ kÃ­ch hoáº¡t lá»‡nh gá»i hÃ m:
1. Gá»­i má»™t message Ä‘Æ°á»£c táº¡o Ä‘áº·c biá»‡t Ä‘á»ƒ con trá» cáº¥u trÃºc SRVNET_RECV cá»§a káº¿t ná»‘i sáº½ Ä‘Æ°á»£c copy vÃ o buffer mÃ  ta cÃ³ thá»ƒ Ä‘á»c.
2. Gá»­i má»™t message há»£p lá»‡ khÃ¡c, message nÃ y sáº½ sá»­ dá»¥ng láº¡i cÃ¹ng má»™t cáº¥u trÃºc SRVNET_RECV, nhÆ°ng chÆ°a Ä‘Ã³ng káº¿t ná»‘i. LÆ°u Ã½ ráº±ng khi káº¿t ná»‘i bá»‹ Ä‘Ã³ng, cáº¥u trÃºc SRVNET_RECV khÃ´ng Ä‘Æ°á»£c giáº£i phÃ³ng. HÃ m SrvNetPrepareConnectionForReuse Ä‘Æ°á»£c gá»i Ä‘á»ƒ set láº¡i cáº¥u trÃºc Ä‘á»ƒ nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng láº¡i cho káº¿t ná»‘i tiáº¿p theo.
3. Äá»c con trá» cáº¥u trÃºc SRVNET_RECV mÃ  ta Ä‘Ã£ copy á»Ÿ bÆ°á»›c 1.
4. Thay tháº¿ con trá» HandlerFunctions vÃ  cÃ¡c Ä‘á»‘i sá»‘ báº±ng cÃ¡ch sá»­ dá»¥ng kÄ© thuáº­t write-what-where primitive.
5. Gá»­i má»™t message bá»• sung qua káº¿t ná»‘i tá»« bÆ°á»›c 2 Ä‘á»ƒ hÃ m thay tháº¿ cho srv2!Srv2ReceiveHandler Ä‘Æ°á»£c gá»i.

BÃ¢y giá» táº¥t cáº£ nhá»¯ng gÃ¬ ta pháº£i lÃ m lÃ  tÃ¬m má»™t hÃ m Ä‘á»ƒ copy bá»™ nhá»› tá»« vá»‹ trÃ­ nÃ y sang vá»‹ trÃ­ khÃ¡c, Ä‘á»ƒ ta cÃ³ thá»ƒ copy bá»™ nhá»› tÃ¹y Ã½ vÃ o pool buffer mÃ  ta cÃ³ thá»ƒ Ä‘á»c tá»« Ä‘Ã³. memcpy lÃ  má»™t lá»±a chá»n vÃ  srvnet.sys cÃ³ má»™t hÃ m nhÆ° váº­y (chÃ­nh xÃ¡c hÆ¡n lÃ  memmove), nhÆ°ng hÃ m nÃ y yÃªu cáº§u Ä‘á»‘i sá»‘ thá»© ba, Ä‘á»‘i sá»‘ dÃ¹ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh sá»‘ byte cáº§n Ä‘Æ°á»£c sao chÃ©p mÃ  ta khÃ´ng kiá»ƒm soÃ¡t Ä‘Æ°á»£c. Tuy nhiÃªn, ta khÃ´ng bá»‹ giá»›i háº¡n bá»Ÿi cÃ¡c hÃ m Ä‘Æ°á»£c triá»ƒn khai trong srvnet.sys, ta cÅ©ng cÃ³ thá»ƒ gá»i cÃ¡c hÃ m tá»« import table cá»§a srvnet vÃ  hÃ m RtlCopyUnicodeString lÃ  má»™t sá»± lá»±a chá»n hoÃ n háº£o Ä‘á»ƒ thá»±c hiá»‡n Ä‘iá»u ta muá»‘n.

HÃ m RtlCopyUnicodeString nháº­n hai con trá» UNICODE_STRING lÃ m Ä‘á»‘i sá»‘ vÃ  sao chÃ©p ná»™i dung cá»§a source string sang destination string. KhÃ´ng giá»‘ng nhÆ° cÃ¡c C string Ä‘Æ°á»£c káº¿t thÃºc báº±ng NULL, cÃ¡c string trong kernel Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh bá»Ÿi cáº¥u trÃºc UNICODE_STRING chá»©a má»™t con trá» trá» Ä‘áº¿n string vÃ  length cá»§a string tÃ­nh báº±ng byte. String buffer cÃ³ thá»ƒ chá»©a báº¥t ká»³ dá»¯ liá»‡u nhá»‹ phÃ¢n nÃ o. Náº¿u báº¡n nhÃ¬n vÃ o code cá»§a hÃ m RtlCopyUnicodeString, báº¡n cÃ³ thá»ƒ tháº¥y ráº±ng viá»‡c copy Ä‘Æ°á»£c thá»±c hiá»‡n vá»›i hÃ m memmove, tá»©c lÃ  copy dá»¯ liá»‡u nhá»‹ phÃ¢n thuáº§n tÃºy. Táº¥t cáº£ nhá»¯ng gÃ¬ chÃºng ta pháº£i lÃ m lÃ  chuáº©n bá»‹ hai cáº¥u trÃºc UNICODE_STRING vÃ  gá»i RtlCopyUnicodeString, sau Ä‘Ã³ Ä‘á»c dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c copy:

![](pic/pic18.png)

## Executing shellcode
Sau khi Ä‘áº¡t Ä‘Æ°á»£c convenient arbitrary read primitive, ta chuyá»ƒn sang thá»­ thÃ¡ch tiáº¿p theo hÆ°á»›ng tá»›i má»¥c tiÃªu Remote Code Execute thÃ´ng qua viá»‡c cháº¡y má»™t shellcode. Ta sáº½ sá»­ dá»¥ng ká»¹ thuáº­t mÃ  Morten Schenk Ä‘Ã£ trÃ¬nh bÃ y trong bÃ i nÃ³i chuyá»‡n vá» [Black Hat USA 2017](https://www.blackhat.com/docs/us-17/wednesday/us-17-Schenk-Taking-Windows-10-Kernel-Exploitation-To-The-Next-Level%E2%80%93Leveraging-Write-What-Where-Vulnerabilities-In-Creators-Update.pdf) (trang 47-51).

Ã tÆ°á»Ÿng lÃ  viáº¿t má»™t mÃ£ shellcode bÃªn dÆ°á»›i cáº¥u trÃºc KUSER_SHARED_DATA cÃ³ Ä‘á»‹a chá»‰ khÃ´ng Ä‘á»•i, Ä‘á»‹a chá»‰ duy nháº¥t khÃ´ng Ä‘Æ°á»£c ngáº«u nhiÃªn hÃ³a trong kernel memory layout cá»§a cÃ¡c phiÃªn báº£n Windows gáº§n Ä‘Ã¢y. Sau Ä‘Ã³, sá»­a Ä‘á»•i page table entry liÃªn quan, lÃ m cho page cÃ³ thá»ƒ execute. Base address cá»§a cÃ¡c page table entry trong kernel lÃ  ngáº«u nhiÃªn, nhÆ°ng Ä‘Æ°á»£c truy xuáº¥t tá»« hÃ m MiGetPteAddress trong ntoskrnl.exe. DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c bÆ°á»›c ta sáº½ sá»­ dá»¥ng Ä‘á»ƒ thá»±c thi shellcode cá»§a mÃ¬nh:
1. Sá»­ dá»¥ng arbitrary read primitive Ä‘á»ƒ láº¥y base address cá»§a ntoskrnl.exe tá»« import table cá»§a srvnet.
2. Äá»c base address cá»§a page table entry tá»« hÃ m MiGetPteAddress, nhÆ° Ä‘Æ°á»£c mÃ´ táº£ trong cÃ¡c trang trÃ¬nh bÃ y cá»§a Morten.
3. Ghi shellcode vÃ o Ä‘á»‹a chá»‰ KUSER_SHARED_DATA + 0x800 (0xFFFFF78000000800). LÆ°u Ã½ ráº±ng ta cÅ©ng cÃ³ thá»ƒ sá»­ dá»¥ng má»™t trong cÃ¡c pool buffer Ä‘á»ƒ lÆ°u trá»¯ shellcode, viá»‡c sá»­ dá»¥ng KUSER_SHARED_DATA lÃ  Ä‘á»ƒ lÃ m má»i thá»© Ä‘Æ¡n giáº£n hÆ¡n.
4. TÃ­nh toÃ¡n Ä‘á»‹a chá»‰ page table entry liÃªn quan vÃ  xÃ³a bit NX Ä‘á»ƒ cho phÃ©p execute, nhÆ° Ä‘Æ°á»£c mÃ´ táº£ trong cÃ¡c trang trÃ¬nh bÃ y cá»§a Morten.
5. Gá»i shellcode báº±ng cÃ¡ch sá»­ dá»¥ng kÄ© thuáº­t Ä‘Ã£ trÃ¬nh bÃ y á»Ÿ trÃªn Ä‘á»ƒ gá»i má»™t hÃ m tÃ¹y Ã½.

Shellcode mÃ  Zecops sá»­ dá»¥ng Ä‘á»ƒ reverse shell lÃ  [sleepyaâ€™s shellcode](https://github.com/worawit/MS17-010/tree/master/shellcode) Ä‘Æ°á»£c viáº¿t phá»¥c vá»¥ cho má»¥c Ä‘Ã­ch khai thÃ¡c EternalBlue. Há» Ä‘Ã£ sá»­a Ä‘á»•i shellcode trÃªn Ä‘á»ƒ cÃ³ thá»ƒ thá»±c hiá»‡n Ä‘Æ°á»£c trÃªn cÃ¡c phiÃªn báº£n windows gáº§n Ä‘Ã¢y

# Debug

![](pic/pic14.png)

ThÃ´ng tin cá»§a má»™t gÃ³i SMB sáº½ cÃ³ cáº¥u trÃºc gáº§n giá»‘ng nhÆ° trÃªn. Giáº£ sá»­ chÃºng ta cáº§n leak Ä‘á»‹a chá»‰ cá»§a User Buffer, ta sáº½ cáº§n Ä‘á»c con trá» UserBufferPtr. Äá»ƒ Ä‘á»c Ä‘Æ°á»£c con trá» nÃ y, ta sáº½ táº­n dá»¥ng [kÄ© thuáº­t](https://github.com/datntsec/CVE-2020-1206#srvnetallocatebuffer-and-the-allocated-buffer-layout) Ä‘áº·t trÆ°á»ng offset náº±m vÆ°á»£t ra khá»i con trá» Ä‘á»ƒ nÃ³ Ä‘Æ°á»£c copy vÃ o vÃ¹ng user buffer cá»§a má»™t buffer khÃ¡c.

VÃ­ dá»¥ vá» gÃ³i SMB do client gá»­i Ä‘i cÃ³ ná»™i dung nhÆ° sau:
```c
Header:
-   Id = 0x424d53fc
-   OriginalCompressedSegmentSize = 0x0
-   CompressionAlgorithm = 1
-   Flag = 0
-   Offset = 0x2116
Data = â€˜Aâ€™ * 0x1101.
```

GÃ³i tin nÃ y khi Ä‘áº¿n server sáº½ Ä‘Æ°á»£c lÆ°u trong má»™t buffer Ä‘Æ°á»£c táº¡o bá»Ÿi hÃ m SrvNetAllocateBuffer, Do toÃ n bá»™ gÃ³i tin cÃ³ kÃ­ch thÆ°á»›c náº±m trong khoáº£ng 0x1100 Ä‘áº¿n 0x2100 nÃªn hÃ m nÃ y sáº½ tráº£ vá» má»™t alloc vá»›i vÃ¹ng user buffer cÃ³ kÃ­ch thÆ°á»›c 0x2100 (ta sáº½ gá»i nÃ³ lÃ  Alloc A), sau Ä‘Ã³ lÆ°u thÃ´ng tin client gá»­i vÃ o nhÆ° hÃ¬nh bÃªn dÆ°á»›i:

![](pic2/pic1.PNG)

Ta cÃ³ thá»ƒ tháº¥y pháº§n tá»« Ä‘á»‹a chá»‰ 0xffffd38439044050 Ä‘áº¿n 0xffffd38439045160 lÃ  dá»¯ liá»‡u do client gá»­i Ä‘áº¿n, pháº§n tá»« 0xffffd38439045160 Ä‘áº¿n 0xffffd38439046150 lÃ  dá»¯ liá»‡u chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o á»Ÿ phÃ­a server, pháº§n tá»« 0xffffd38439046150 Ä‘áº¿n 0xffffd38439046240 lÃ  dá»¯ liá»‡u cá»§a SRVNET_BUFFER_HDR cá»§a Alloc A. NhÆ° váº­y con trá» mÃ  ta muá»‘n Ä‘á»c sáº½ náº±m á»Ÿ 0xffffd38439046150 + 0x18 = 0xffffd38439046168.

Äá»ƒ Ä‘á»c Ä‘Æ°á»£c con trá» nÃ y, tÃ´i Ä‘Ã£ sá»­ dá»¥ng [kÄ© thuáº­t](https://github.com/datntsec/CVE-2020-1206#srvnetallocatebuffer-and-the-allocated-buffer-layout
) mÃ  tÃ´i Ä‘Ã£ nÃ³i á»Ÿ trÃªn, Ä‘áº·t trÆ°á»ng offset vÆ°á»£t ra ngoÃ i con trá» cáº§n Ä‘á»c. ChÃ­nh vÃ¬ váº­y mÃ  gÃ³i tin trÃªn dÃ¹ cÃ³ kÃ­ch thÆ°á»›c nhá» hÆ¡n 0x2100 nhÆ°ng offset láº¡i Ä‘Æ°á»£c set 0x2116. 

Tiáº¿p theo, SMB server sáº½ gá»i hÃ m SrvNetAllocateBuffer Ä‘á»ƒ cáº¥p phÃ¡t má»™t vÃ¹ng nhá»› dá»±a trÃªn tá»•ng cá»§a OriginalCompressedSegmentSize vÃ  Offset (0x2116) . Tá»« Ä‘Ã³ cáº¥p phÃ¡t má»™t alloc vá»›i vÃ¹ng user buffer cÃ³ kÃ­ch thÆ°á»›c 0x4100 (ta sáº½ gá»i nÃ³ lÃ  Alloc B). Dá»¯ liá»‡u Ä‘Æ°á»£c cáº¥p phÃ¡t sáº½ cÃ³ dáº¡ng nhÆ° sau:

![](pic2/pic2.PNG)

Äá»ƒ trÃ¡nh cÃ¡c lá»—i khÃ´ng mong muá»‘n, trÆ°á»›c Ä‘Ã³ tÃ´i Ä‘Ã£ táº¡o Ä‘i táº¡o láº¡i nhiá»u láº§n cÃ¡c buffer cÃ¹ng lookasite list vá»›i Alloc B vÃ  láº¥p Ä‘áº§y cÃ¡c byte 0x0 vÃ o nÃ³.

Tiáº¿p theo, SMB server sáº½ tiáº¿n hÃ nh giáº£i nÃ©n data Ä‘Æ°á»£c nÃ©n vÃ  copy data khÃ´ng Ä‘Æ°á»£c nÃ©n do client gá»­i vÃ o vÃ¹ng user buffer cá»§a Alloc B:

![](pic2/pic3.PNG)

NhÆ° ta cÃ³ thá»ƒ tháº¥y, dá»¯ liá»‡u nÃ©n lÃ  khÃ´ng cÃ³ do OriginalCompressedSegmentSize = 0, chÆ°Æ¡ng trÃ¬nh sáº½ copy dá»¯ liá»‡u tá»« 0xffffd38439044060 Ä‘áº¿n 0xffffd38439044060 + 0x2116 = 0xffffd38439046176 cá»§a Alloc A vÃ o vÃ¹ng user buffer cá»§a Alloc B. NhÆ° váº­y, má»™t pháº§n thÃ´ng tin SRVNET_BUFFER_HDR cá»§a Alloc A Ä‘Ã£ Ä‘Æ°á»£c copy vÃ o vÃ¹ng user buffer cá»§a Alloc B.

BÃ¢y giá» ta sáº½ sá»­ dá»¥ng [kÄ© thuáº­t](https://github.com/datntsec/CVE-2020-1206#a-different-approach--decompression) mÃ  ta Ä‘Ã£ nÃ³i trÆ°á»›c Ä‘Ã³ Ä‘á»ƒ leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a allocation pool (Ä‘á»‹a chá»‰ cá»§a User Buffer).

Giáº£ sá»­ ta muá»‘n biáº¿t má»™t byte á»Ÿ Ä‘á»‹a chá»‰ 0xffffd3843636f15e cÃ³ lá»›n hÆ¡n 0x7f hay khÃ´ng? Ta sáº½ tiáº¿n hÃ nh táº¡o má»™t gÃ³i SMB vá»›i thÃ´ng tin nhÆ° sau:
``` c
Header:
-   Id = 0x424d53fc
-   OriginalCompressedSegmentSize = 0x1ff2
-   CompressionAlgorithm = 1
-   Flag = 0
-   Offset = 0x210e
Data = â€˜Bâ€™ * 0x210e + compress(â€˜\xb0â€™ + â€˜\x00â€™*(0x7f+3) + â€˜\xffâ€™*(0xff - 0x7f)) + â€˜\xffâ€™*0x1fe9
```

Táº¡i sao cáº§n pháº£i táº¡o má»™t SMB nhÆ° váº­y, ta sáº½ phÃ¢n tÃ­ch tá»«ng chÃºt má»™t. Äáº§u tiÃªn tá»•ng cá»§a OriginalCompressedSegmentSize vÃ  Offset lÃ  0x4100, nhÆ° váº­y nÃ³ sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng láº¡i má»™t alloc cÃ³ user buffer tÆ°Æ¡ng tá»±, tá»©c lÃ  Alloc B Ä‘Ã£ dÃ¹ng trÆ°á»›c Ä‘Ã³. VÃ¬ ta muá»‘n Ä‘oÃ¡n 1 byte á»Ÿ Ä‘á»‹a chá»‰ 0xffffd3843636f15e cÃ³ lá»›n hÆ¡n 0x7f hay khÃ´ng, Ä‘á»‹a chá»‰ nÃ y náº±m cÃ¡ch Ä‘á»‹a chá»‰ user buffer lÃ  0x210e nÃªn dá»¯ liá»‡u khÃ´ng nÃ©n sáº½ cÃ³ 0x210e byte (â€˜Bâ€™ * 0x210e). Tiáº¿p theo sáº½ lÃ  vÃ¹ng dá»¯ liá»‡u Ä‘Æ°á»£c nÃ©n há»£p lá»‡ (Ä‘Æ°á»£c nÃ©n bá»Ÿi hÃ m compress()), theo sau lÃ  má»™t dá»¯ liá»‡u nÃ©n khÃ´ng há»£p lá»‡ (â€˜\xffâ€™* 0x1fe9). Äá»ƒ khi tiáº¿n hÃ nh giáº£i nÃ©n, chá»‰ cÃ³ pháº§n dá»¯ liá»‡u nÃ©n há»£p lá»‡ Ä‘Æ°á»£c giáº£i nÃ©n vÃ o vÃ¹ng alloc khÃ¡c, sau Ä‘Ã³ káº¿t ná»‘i sáº½ bá»‹ ngáº¯t do dá»¯ liá»‡u nÃ©n khÃ´ng há»£p lá»‡ á»Ÿ sau, vÃ¹ng data khÃ´ng nÃ©n sáº½ khÃ´ng Ä‘Æ°á»£c copy vÃ o alloc Ä‘Ã³, tá»« Ä‘Ã³ pháº§n Ä‘á»¯ liá»‡u ta Ä‘Ã£ copy á»Ÿ trÆ°á»›c sáº½ Ä‘Æ°á»£c giá»¯ nguyÃªn.

![](pic2/pic4.PNG)

BÃªn trÃªn lÃ  má»™t Alloc chá»©a cÃ¡c thÃ´ng tin mÃ  ta Ä‘Ã£ nÃ³i á»Ÿ trÃªn Ä‘Æ°á»£c táº¡o bá»Ÿi SMB server. Tiáº¿p theo, SMB Server sáº½ gá»i hÃ m SrvNetAllocateBuffer Ä‘á»ƒ táº¡o ra má»™t Alloc tÆ°Æ¡ng á»©ng. VÃ¬ tá»•ng OriginalCompressedSegmentSize vÃ  Offset cá»§a nÃ³ lÃ  0x4100 nÃªn Alloc B sáº½ Ä‘Æ°á»£c tÃ¡i sá»­ dá»¥ng:

![](pic2/pic5.PNG)

Sau Ä‘Ã³ SMB server tiáº¿n hÃ nh giáº£i nÃ©n thÃ´ng tin Ä‘Æ°á»£c gá»­i tá»« client vÃ o vÃ¹ng user buffer cá»§a Alloc B á»©ng vá»›i offset.

![](pic2/pic6.PNG)

CÃ¡c dá»¯ liá»‡u mÃ u Ä‘á» lÃ  dá»¯ liá»‡u Ä‘Æ°á»£c giáº£i nÃ©n, pháº§n cÃ²n láº¡i sáº½ Ä‘Æ°á»£c giá»¯ nguyÃªn. NhÆ° hÃ¬nh trÃªn ta cÃ³ thá»ƒ tháº¥y, byte chÃºng ta cáº§n biáº¿t sáº½ Ä‘Æ°á»£c giá»¯ nguyÃªn, ngay sau nÃ³ lÃ  dá»¯ liá»‡u vá»«a Ä‘Æ°á»£c giáº£i nÃ©n.

Äá»ƒ biáº¿t byte nÃ y cÃ³ lá»›n hÆ¡n 0x7f hay khÃ´ng, ta tiáº¿n hÃ nh lÃ m nhÆ° sau:

Ta tiáº¿p tá»¥c táº¡o má»™t gÃ³i SMB vá»›i ná»™i dung nhÆ° sau:
``` c
Header:
-   Id = 0x424d53fc
-   OriginalCompressedSegmentSize = 0x2004
-   CompressionAlgorithm = 1
-   Flag = 0
-   Offset = 0x20fd
Data = â€˜Bâ€™ * 0x20f1
```

Máº·c dÃ¹ tá»•ng OriginalCompressedSegmentSize vÃ  Offset lÃ  lá»›n hÆ¡n 0x4100 nhÆ°ng khi cáº¥p phÃ¡t vÃ¹ng alloc Ä‘á»ƒ lÆ°u gÃ³i tin Ä‘Æ°á»£c gá»­i Ä‘áº¿n tá»« client (vá»›i tá»•ng kÃ­ch thÆ°á»›c dÆ°á»›i 0x4100), SMB server váº«n chá»‰ cáº¥p phÃ¡t má»™t Alloc cÃ³ vÃ¹ng user buffer lÃ  0x4100 byte nhÆ° hÃ¬nh bÃªn dÆ°á»›i:


![](pic2/pic7.PNG)

CÃ¡c dá»¯ liá»‡u Ä‘Æ°á»£c tÃ´ mÃ u xanh lÃ¡ nhÆ° trÃªn lÃ  nhá»¯ng dá»¯ liá»‡u cá»§a Alloc B Ä‘Æ°á»£c cáº¥p phÃ¡t láº§n trÆ°á»›c, do cÃ¹ng lookaside list nÃªn Ä‘Æ°á»£c tÃ¡i sá»­ dá»¥ng.

Tiáº¿p theo SMB Server sáº½ gá»i hÃ m SrvNetAllocateBuffer Ä‘á»ƒ cáº¥p phÃ¡t má»™t Alloc chá»©a dá»¯ liá»‡u sau khi giáº£i nÃ©n:

![](pic2/pic8.PNG)

Qua viá»‡c giáº£i nÃ©n, SMB server sáº½ láº¥y dá»¯ liá»‡u tá»« User buffer address + Offset = 0xffffd3843636d060 + 20fd = 0xffffd3843636f15d. Dá»¯ liá»‡u Ä‘Æ°á»£c láº¥y ra sáº½ cÃ³ dáº¡ng nhÆ° sau:

![](pic2/pic9.PNG)

Vá»›i thuáº­t toÃ¡n giáº£i nÃ©n Ä‘Ã£ Ä‘Æ°á»£c nÃ³i á»Ÿ trÃªn, nÃ³ sáº½ tiáº¿n hÃ nh láº¥y ra 2 byte Ä‘áº§u tiÃªn vÃ  sá»­ dá»¥ng nhÆ° length cá»§a block, dá»±a vÃ o length Ä‘Ã³ nÃ³ sáº½ láº¥y ra pháº§n tiáº¿p theo sau length vÃ  giáº£i nÃ©n.
NhÆ° trÃªn thÃ¬ length sáº½ lÃ  0xB0D3, tuy nhiÃªn theo thuáº­t toÃ¡n, thÃ¬ length tháº­t cá»§a nÃ³ sáº½ theo cÃ´ng thá»©c: length = length  & 0xFFF + 1 â†’ length sáº½ lÃ  0xD4. NÃ³ sáº½ láº¥y ra D4 byte tiáº¿p theo vÃ  tiáº¿n hÃ nh giáº£i nÃ©n bÃ¬nh thÆ°á»ng cho Ä‘áº¿n khi gáº·p Ä‘Æ°á»£c byte FF (do 0xD4 byte sáº½ gá»“m cáº£ táº¥t cáº£ byte 00 vÃ  má»™t pháº§n byte FF), lÃºc nÃ y dá»¯ liá»‡u nÃ©n Ä‘Æ°á»£c coi lÃ  khÃ´ng há»£p lá»‡, nÃ³ sáº½ khÃ´ng giáº£i nÃ©n tiáº¿p vÃ  ngáº¯t káº¿t ná»‘i. 

![](pic2/pic10.PNG)

Dá»±a vÃ o viá»‡c ngáº¯t káº¿t ná»‘i cá»§a server, ta cÃ³ thá»ƒ Ä‘oÃ¡n byte mÃ  ta cáº§n biáº¿t sáº½ lá»›n hÆ¡n 0x7f.

Váº­y vá»›i viá»‡c byte ta cáº§n Ä‘oÃ¡n nhá» hÆ¡n thÃ¬ sao. Ta sáº½ tiáº¿p tá»¥c phÃ¢n tÃ­ch á»Ÿ trÃªn, nhÆ°ng láº§n nÃ y ta sáº½ dÃ¹ng byte so sÃ¡nh lÃ  D7, nhÆ° váº­y D3 sáº½ nhá» hÆ¡n D7. Ta cÃ¹ng xem chuyá»‡n gÃ¬ sáº½ xáº£y ra:

Äáº§u tiÃªn gá»­i Ä‘áº¿n SMB server gÃ³i tin nhÆ° sau:
``` c
Header:
-   Id = 0x424d53fc
-   OriginalCompressedSegmentSize = 0x1ff2
-   CompressionAlgorithm = 1
-   Flag = 0
-   Offset = 0x210e
Data = â€˜Bâ€™ * 0x210e + compress(â€˜\xb0â€™ + â€˜\x00â€™*(0xd7+3) + â€˜\xffâ€™*(0xff - 0xd7)) + â€˜\xffâ€™*0x1fe9
```

PhÃ­a SMB server sáº½ táº¡o má»™t alloc lÆ°u trá»¯ nhÆ° sau:

![](pic2/pic11.PNG)

Tiáº¿p theo nÃ³ sáº½ gá»i hÃ m SrvNetAllocateBuffer Ä‘á»ƒ cáº¥p phÃ¡t má»™t alloc nhÆ° sau:

![](pic2/pic12.PNG)

Táº¥t nhiÃªn alloc nÃ y Ä‘Æ°á»£c tÃ¡i sá»­ dá»¥ng láº¡i tá»« alloc cÃ³ cÃ¹ng lookasidelist (Alloc B). Sau Ä‘Ã³ chÆ°Æ¡ng trÃ¬nh tiáº¿n hÃ nh giáº£i nÃ©n bÃ¬nh thÆ°á»ng vá»›i dá»¯ liá»‡u nÃ©n há»£p lá»‡, vÃ  ngáº¯t káº¿t ná»‘i vá»›i dá»¯ liá»‡u nÃ©n khÃ´ng há»£p lá»‡:

![](pic2/pic13.PNG)

BÆ°á»›c tiáº¿p theo, ta sáº½ gá»­i tiáº¿p má»™t dá»¯ liá»‡u tÆ°Æ¡ng tá»± nhÆ° láº§n trÆ°á»›c vÃ  SMB server sáº½ cáº¥p phÃ¡t má»™t alloc tÆ°Æ¡ng á»©ng: 

![](pic2/pic14.PNG)

CÃ¡c dá»¯ liá»‡u Ä‘Æ°á»£c tÃ´ mÃ u xanh lÃ¡ nhÆ° trÃªn lÃ  nhá»¯ng dá»¯ liá»‡u cá»§a Alloc B Ä‘Æ°á»£c cáº¥p phÃ¡t láº§n trÆ°á»›c, do cÃ¹ng lookaside list nÃªn Ä‘Æ°á»£c tÃ¡i sá»­ dá»¥ng.

Tiáº¿p theo SMB Server sáº½ gá»i hÃ m SrvNetAllocateBuffer Ä‘á»ƒ cáº¥p phÃ¡t má»™t Alloc chá»©a dá»¯ liá»‡u sau khi giáº£i nÃ©n:

![](pic2/pic15.PNG)

Qua viá»‡c giáº£i nÃ©n, SMB server sáº½ láº¥y dá»¯ liá»‡u tá»« User buffer address + Offset = 0xffffd3843636d060 + 20fd = 0xffffd3843636f15d. Dá»¯ liá»‡u Ä‘Æ°á»£c láº¥y ra sáº½ cÃ³ dáº¡ng nhÆ° sau:

![](pic2/pic16.PNG)

TÆ°Æ¡ng tá»± nhÆ° láº§n trÆ°á»›c thÃ¬ length ban Ä‘áº§u sáº½ lÃ  0xB0D3, qua tÃ­nh toÃ¡n sáº½ thÃ nh 0xD4. VÃ  nÃ³ sáº½ láº¥y ra D4 byte tiáº¿p theo vÃ  tiáº¿n hÃ nh giáº£i nÃ©n bÃ¬nh thÆ°á»ng. Tuy nhiÃªn do D4 < D7 nÃªn dá»¯ liá»‡u nÃ©n Ä‘Æ°á»£c láº¥y ra Ä‘á»ƒ giáº£i nÃ©n lÃºc nÃ y chá»‰ chá»©a toÃ n byte 0. NÃ³ sáº½ giáº£i nÃ©n bÃ¬nh thÆ°á»ng cho Ä‘áº¿n háº¿t block Ä‘Ã³. Tiáº¿p theo nÃ³ sáº½ láº¥y ra Ä‘á»™ dÃ i cá»§a block tiáº¿p theo thÃ´ng qua Ä‘á»™ dÃ i cá»§a block trÆ°á»›c Ä‘Ã³, hai byte tiáº¿p theo lÃ  D5 vÃ  D6 lÃ  0x0, nÃªn Ä‘á»™ dÃ i cá»§a nÃ³ lÃºc nÃ y lÃ  0x0, do Ä‘Ã³ length láº¥y ra sáº½ lÃ   0x0000 â†’ káº¿t thÃºc quÃ¡ trÃ¬nh giáº£i nÃ©n â†’ giáº£i nÃ©n thÃ nh cÃ´ng  â†’ SMB server tráº£ láº¡i má»™t response â†’ ta biáº¿t Ä‘Æ°á»£c byte cáº§n biáº¿t nhá» hÆ¡n hoáº·c báº±ng 0xD7. 

TÆ°Æ¡ng tá»± nhÆ° váº­y ta sáº½ lÃ m cho Ä‘áº¿n khi leak Ä‘Æ°á»£c toÃ n bá»™ 6 byte cá»§a má»™t address. Ta sáº½ cÃ³ Ä‘Æ°á»£c allocation pool address.

Khi cÃ³ Ä‘Æ°á»£c allocation pool address, ta sáº½ tiáº¿n hÃ nh tÃ¬m Ä‘á»‹a chá»‰ srvnet base address thÃ´ng qua viá»‡c láº¥y con trá» trá» tá»›i cáº¥u trÃºc SRVNET_RECV báº±ng cÃ¡ch tÆ°Æ¡ng tá»± nhÆ° leak allocation pool address. 

Sau khi cÃ³ Ä‘Æ°á»£c 2 Ä‘á»‹a chá»‰: allocation pool vÃ  SRVNET_RECV láº§n lÆ°á»£t cÃ³ giÃ¡ trá»‹: `0xffffd38439044000` vÃ  `0xffffd3843654ddd8`, ta tiáº¿n hÃ nh leak srvnet base address. 

![](pic/pic15.png)

![](pic2/pic17.PNG)

Äá»ƒ Ä‘á»c con trá» AcceptSocket, ta cáº§n lÃ m nhÆ° sau:
1. Chuáº©n bá»‹ Alloc A tá»« má»™t lookaside list sao cho vÃ¹ng â€œUser bufferâ€ Ä‘Æ°á»£c láº¥p Ä‘áº§y bá»Ÿi cÃ¡c sá»‘ 0. Buffer nÃ y sau Ä‘Ã³ sáº½ chá»©a con trá» mÃ  chÃºng ta sáº½ Ä‘á»c. á» Ä‘Ã¢y Alloc A sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng tá»« Alloc á»©ng vá»›i allocation pool address mÃ  ta leak Ä‘Æ°á»£c. Do Ä‘Ã³, vÃ¹ng User buffer cá»§a Alloc A sáº½ báº¯t Ä‘áº§u tá»« Ä‘á»‹a chá»‰ 0xffffd38439044050 thÃ´ng qua viá»‡c sá»­ dá»¥ng chung má»™t lookaside list. 
2. Chuáº©n bá»‹ Alloc B tá»« má»™t lookaside list khÃ¡c Ä‘á»ƒ:
- Con trá» pMdl1 trá» Ä‘áº¿n Ä‘á»‹a chá»‰ cá»§a con trá» AcceptSocket trá»« Ä‘i 0x18, (do offset cá»§a MappedSystemVa lÃ  0x18 trong cáº¥u trÃºc MDL). 
- Con trá» pMdl2 trá» Ä‘áº¿n vÃ¹ng â€œUser bufferâ€ cá»§a Buffer A.
- TrÆ°á»ng Flags Ä‘Æ°á»£c set thÃ nh 0x03.

NhÆ° váº­y Ä‘á»‹a chá»‰ cá»§a 2 con trá» Mdl láº§n lÆ°á»£t lÃ : mdl1_ptr: `0xffffd3843654de68`, mdl2_ptr: `0xffffd38439045250`.

Ta cÃ³ thá»ƒ ghi Ä‘Ã¨ cÃ¡c trÆ°á»ng cáº¥u trÃºc SRVNET_BUFFER_HDR báº±ng cÃ¡ch giáº£i nÃ©n chÃºng tá»« buffer lá»›n hÆ¡n thÃ´ng qua ká»¹ thuáº­t Ä‘Æ°á»£c mÃ´ táº£ trong pháº§n [Observation #2](https://github.com/datntsec/CVE-2020-1206#observation-2-failing-the-decompression).

TÃ´i sáº½ nÃ³i rÃµ hÆ¡n bÆ°á»›c nÃ y ngay sau bÆ°á»›c 4.

3. Khi Buffer B Ä‘Æ°á»£c giáº£i phÃ³ng, cÃ¡c hoáº¡t Ä‘á»™ng sau sáº½ diá»…n ra:
- CÃ¡c MDL flags sáº½ Ä‘Æ°á»£c Ä‘á»c tá»« MDL thá»© hai táº¡i buffer A. Náº¿u MDL_PARTIAL_HAS_BEEN_MAPPED flag Ä‘Æ°á»£c set, MmUnmapLockedPages sáº½ Ä‘Æ°á»£c gá»i vÃ  há»‡ thá»‘ng cÃ³ kháº£ nÄƒng bá»‹ crash. ÄÃ³ lÃ  lÃ½ do táº¡i sao ta pháº£i láº¥p Ä‘áº§y buffer báº±ng cÃ¡c sá»‘ 0 á»Ÿ bÆ°á»›c 1.
- VÃ¹ng â€œUser bufferâ€ cá»§a Alloc A sáº½ Ä‘Æ°á»£c sá»­a Ä‘á»•i vÃ  chá»©a cÃ¡c thÃ´ng tin mÃ  ta cáº§n Ä‘á»c.
4. Äá»c con trá» AcceptSocket tá»« vÃ¹ng â€œUser bufferâ€ cá»§a buffer A.
- Sá»­ dá»¥ng kÄ© thuáº­t leak Ä‘á»‹a chá»‰ Ä‘Ã£ dÃ¹ng á»Ÿ trÃªn Ä‘á»ƒ Ä‘á»c con trá» AcceptSocket.

Sau Ä‘Ã¢y tÃ´i sáº½ mÃ´ táº£ rÃµ hÆ¡n vá» cÃ¡c bÆ°á»›c trÃªn:

á» bÆ°á»›c 1 khÃ¡ Ä‘Æ¡n giáº£n  vÃ  tÆ°Æ¡ng tá»± nhÆ° trÃªn, nÃªn tÃ´i sáº½ khÃ´ng nÃ³i Ä‘áº¿n ná»¯a.

á» bÆ°á»›c 2, Ä‘áº§u tiÃªn ta sáº½ táº¡o má»™t gÃ³i tin gá»­i Ä‘áº¿n SMB Server vá»›i ná»™i dung nhÆ° sau:
``` c
Header:
-   Id = 0x424d53fc
-   OriginalCompressedSegmentSize = -0x38
-   CompressionAlgorithm = 1
-   Flag = 0
-   Offset = 0x10138
Data = â€˜Aâ€™ * 0x10138 + compress(mdl1_ptr  + â€˜\x00â€™*0x10 + mdl2_ptr) + â€˜\xffâ€™*0x10
```

NhÆ° ta cÃ³ thá»ƒ tháº¥y, OriginalCompressedSegmentSize chá»©a giÃ¡ trá»‹ Ã¢m vÃ  tá»•ng OriginalCompressedSegmentSize + Offset = 0x10100. Tuy nhiÃªn kÃ­ch thÆ°á»›c gÃ³i tin mÃ  client gá»­i Ä‘áº¿n server lá»›n hÆ¡n 0x10100. NhÆ° váº­y Alloc ban Ä‘áº§u do server táº¡o trÆ°á»›c khi giáº£i nÃ©n sáº½ lá»›n hÆ¡n Alloc chá»©a dá»¯ liá»‡u sau khi giáº£i nÃ©n. GiÃ¡ trá»‹ OriginalCompressedSegmentSize Ä‘Æ°á»£c set Ã¢m á»Ÿ Ä‘Ã¢y Ä‘Ãª giÃºp tá»•ng OriginalCompressedSegmentSize vÃ  Offset Ä‘Ãºng báº±ng vá»›i 0x10100, mÃ  khÃ´ng lÃ m áº£nh hÆ°á»Ÿng Ä‘áº¿n vá»‹ trÃ­ cá»§a dá»¯ liá»‡u nÃ©n, vÃ¬ nÃ³ tÃ¹y thuá»™c vÃ o Offset. CÃ²n 0x38 lÃ  offset cá»§a con trá» Mdl1 trong cáº¥u trÃºc SRVNET_BUFFER_HDR.

NhÆ° váº­y server sáº½ táº¡o ra má»™t Alloc chá»©a dá»¯ liá»‡u cá»§a client nhÆ° sau:

![](pic2/pic18.PNG)

Tiáº¿p theo nÃ³ sáº½ gá»i hÃ m SrvNetAllocateBuffer Ä‘á»ƒ cáº¥p phÃ¡t má»™t alloc cÃ³ kÃ­ch thÆ°á»›c vÃ¹ng User buffer lÃ  0x10100, tá»©c Alloc B theo nhÆ° cÃ¡c bÆ°á»›c á»Ÿ trÃªn:

![](pic2/pic19.PNG)

Tiáº¿n hÃ nh giáº£i nÃ©n, táº¥t nhiÃªn chá»‰ giáº£i nÃ©n Ä‘Æ°á»£c má»™t pháº§n dá»¯ liá»‡u há»£p lá»‡:

![](pic2/pic20.PNG)

Dá»±a vÃ o cÃ¡c hÃ¬nh trÃªn, cÃ³ thá»ƒ tháº¥y Ä‘Æ°á»£c vÃ¹ng 2 con trá» Mdl trong SRVNET_BUFFER_HDR cá»§a Alloc B Ä‘Ã£ Ä‘Æ°á»£c sá»­a Ä‘á»•i thÃ nh giÃ¡ trá»‹ mÃ  ta mong muá»‘n.

TÆ°Æ¡ng tá»± nhÆ° trÃªn, láº§n nÃ y ta sáº½ set flag báº±ng 3 thÃ´ng qua viá»‡c Ä‘iá»u chá»‰nh offset cá»§a gÃ³i tin gá»­i Ä‘i nhÆ° sau:
``` c
Header:
-   Id = 0x424d53fc
-   OriginalCompressedSegmentSize = -0x10
-   CompressionAlgorithm = 1
-   Flag = 0
-   Offset = 0x10110
Data = â€˜Aâ€™ * 0x10110 + compress(â€˜\x00\x03â€™) + â€˜\xffâ€™*0x10
```

Cuá»‘i cÃ¹ng nÃ³ sáº½ cÃ³ dáº¡ng:

![](pic2/pic21.PNG)

Khi Alloc B Ä‘Æ°á»£c giáº£i phÃ³ng thÃ¬ cÃ¡c Ä‘oáº¡n code sau sáº½ Ä‘Æ°á»£c cháº¡y:
``` c
pMdl1->MappedSystemVa = (BYTE*)pMdl1->MappedSystemVa + 0x50;
pMdl1->ByteCount -= 0x50;
pMdl1->ByteOffset += 0x50;
pMdl1->MdlFlags |= 0x1000; // MDL_NETWORK_HEADER

pMdl2->StartVa = (PVOID)((ULONG_PTR)pMdl1->MappedSystemVa & ~0xFFF);
pMdl2->ByteCount = pMdl1->ByteCount;
pMdl2->ByteOffset = pMdl1->MappedSystemVa & 0xFFF;
pMdl2->Size = /* some calculation */;
pMdl2->MdlFlags = 0x0004; // MDL_SOURCE_IS_NONPAGED_POOL
```

NhÆ° trÃªn thÃ¬ pMdl1->MappedSystemVa (offset 0x18) sáº½ chá»©a giÃ¡ trá»‹ cá»§a pMdl1->MappedSystemVa + 0x50 = 0xffffd3843654de68 + 0x18 + 0x50 = 0xffffd3843654ded0.

TrÆ°á»›c khi free Alloc B thÃ¬ SRVNET_RECV sáº½ lÃ :

![](pic2/pic22.PNG)

Sau khi cháº¡y 4 dÃ²ng Ä‘áº§u cá»§a Ä‘oáº¡n code trÃªn thÃ¬:

![](pic2/pic23.PNG)

TrÆ°á»›c khi free Alloc a sáº½:

![](pic2/pic24.PNG)

Sau khi cháº¡y háº¿t Ä‘oáº¡n code trÃªn:

![](pic2/pic25.PNG)

VÃ  cÃ¡c byte mÃ  ta cáº§n Ä‘á»c á»Ÿ Alloc A sáº½ lÃ  cÃ¡c byte mÃ u xanh sau:

![](pic2/pic26.PNG)

NhÆ° váº­y ta chá»‰ cáº§n sá»­ dá»¥ng kÄ© thuáº­t leak tá»«ng byte á»Ÿ trÃªn lÃ  sáº½ cÃ³ Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a AcceptSocket + 0x50. NhÆ° trong pháº§n nÃ y thÃ¬ sáº½ lÃ  0xffffd3843ea02418 â†’ AcceptSocket: 0xffffd3843ea023c8

TÆ°Æ¡ng tá»± ta sáº½ lÃ m Ä‘á»ƒ leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ AcceptSocketâ†’ srvnet!SrvNetWskConnDispatch

Ta cáº§n chuáº©n bá»‹ má»i thá»© nhÆ° sau:

![](pic2/pic27.PNG)

Sau khi Alloc B Ä‘Æ°á»£c giáº£i phÃ³ng, má»i thá»© sáº½ thay Ä‘á»•i nhÆ° sau:

![](pic2/pic28.PNG)

CÃ¡c byte mÃ  chÃºng ta cáº§n biáº¿t Ä‘á»ƒ cÃ³ Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a AcceptSocket-> srvnet!SrvNetWskConnDispatch + 50 sáº½ náº±m trong Alloc A, cÃ¡c byte Ä‘Ã³ lÃ  cÃ¡c byte Ä‘Æ°á»£c tÃ´ mÃ u xanh á»Ÿ hÃ¬nh bÃªn dÆ°á»›i:

![](pic2/pic29.PNG)

NhÆ° váº­y AcceptSocket-> srvnet!SrvNetWskConnDispatch sáº½ lÃ  0xfffff80060e9d170, giáº£ sá»­ ta Ä‘Ã£ biáº¿t Ä‘Æ°á»£c offset cá»§a nÃ³ trong module srvnet.sys, ta sáº½ tÃ­nh Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a srvnet base.

NhÆ° pháº§n nÃ y thÃ¬ srvnet base lÃ : 0xFFFFF80060E70000â€¬ vá»›i offset cá»§a  srvnet!SrvNetWskConnDispatch lÃ  0x2d170.

Tiáº¿p theo ta sáº½ sá»­ dá»¥ng kÄ© thuáº­t Write-what-where primitive á»Ÿ CVE-2020-0796 Ä‘á»ƒ ghi tÃ¹y Ã½ vÃ o má»™t vÃ¹ng nhá»›.

Äáº§u tiÃªn ta sáº½ tÃ¬m cÃ¡ch leak ntoskrnl base address, thÃ´ng qua leak Ä‘á»‹a chá»‰ hÃ m IoSizeofWorkItem Ä‘Æ°á»£c srvnet import. Äá»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u nÃ y, trÆ°á»›c tiÃªn ta sáº½ táº¡o 2 cáº¥u trÃºc UNICODESTRING nhÆ° sau:
``` c
// Destination unicode string
desLength = 6;
desMaximumLength = 6;
desBuffer = allocation_pool_object_ptr + 0x1650 + 0x20 + 2;

// Source unicode string
srcLength = 6;
srcMaximumLength = 6;
srcBuffer = srvnet_base_ptr + OFFSETS['srvnet!imp_IoSizeofWorkItem'];
```

Vá»›i `allocation_pool_object_ptr` lÃ  Ä‘á»‹a chá»‰ allocation pool Ä‘Ã£ leak Ä‘Æ°á»£c vÃ  `OFFSETS['srvnet!imp_IoSizeofWorkItem']` lÃ  offset cá»§a hÃ m IoSizeofWorkItem Ä‘Æ°á»£c import bá»Ÿi srvnet.

2 cáº¥u trÃºc UNICODE_STRING nÃ y sáº½ Ä‘Æ°á»£c lÆ°u táº¡i `allocation_pool_object_ptr + 0x1650` thÃ´ng qua kÄ© thuáº­t Write-what-where Ä‘Ã£ tÃ¬m Ä‘Æ°á»£c á»Ÿ CVE-2020-0796. 
Äáº§u tiÃªn ta sáº½ lÆ°u Destination unicode string vÃ o `allocation_pool_object_ptr + 0x1650`, ta tiáº¿n hÃ nh táº¡o gÃ³i SMB nhÆ° sau:
``` c
Header:
-   Id = 0x424d53fc
-   OriginalCompressedSegmentSize = 0xffffffff
-   CompressionAlgorithm = 1
-   Flag = 0
-   Offset = 0x22
Data:
sentinel = os.urandom(2)  // 16 bits for verification
data = struct.pack('<HHIQ', desLength, desMaximumLength, 0, desBuffer)  // dest unicode string
data += struct.pack('<HHIQ', srcLength, srcMaximumLength, 0, srcBuffer) // src unicode string
data += sentinel
data_to_compress = os.urandom(0x1100 - len(data))
// 0x18 null bytes that override the struct.
data_to_compress += b'\x00'*0x18
// Target address.
data_to_compress += struct.pack('<Q', allocation_pool_object_ptr + 0x1650)
data = data + compress(data_to_compress)
```

á» trÃªn, data cÃ³ chá»©a sentinel Ä‘Æ°á»£c táº¡o ra báº±ng hÃ m os.urandom(2), nÃ³ sáº½ cÃ³ Ä‘á»™ dÃ i 2 byte, vÃ  2 byte nÃ y sáº½ giÃºp ta biáº¿t Ä‘Æ°á»£c Ä‘á»‹a chá»‰ ta leak ra cÃ³ Ä‘Ãºng lÃ  Ä‘á»‹a chá»‰ ta cáº§n leak hay khÃ´ng thÃ´ng qua viá»‡c so sÃ¡nh nÃ³ sau khi quÃ¡ trÃ¬nh leak thÃ nh cÃ´ng.

Náº¿u tá»•ng kÃ­ch thÆ°á»›c cá»§a gÃ³i tin gá»­i Ä‘i tá»« client lá»›n hÆ¡n 0x1100 (Ä‘iá»u nÃ y sáº½ tÃ¹y thuá»™c vÃ o dá»¯ liá»‡u Ä‘Æ°á»£c random trÆ°á»›c khi nÃ©n) thÃ¬ cháº¯c cháº¯n `allocation_pool_object_ptr` sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ chá»©a nÃ³ trÃªn SMB server:

![](pic2/pic30.PNG)

Tiáº¿p theo SMB server sáº½ gá»i hÃ m SrvNetAllocateBuffer Ä‘á»ƒ cáº¥p phÃ¡t má»™t vÃ¹ng nhá»› phá»¥c vá»¥ cho viá»‡c giáº£i nÃ©n. NhÆ°ng do tá»•ng cá»§a OriginalCompressedSegmentSize vÃ  Offset lÃ  0x21 nÃªn nÃ³ chá»‰ cáº¥p phÃ¡t má»™t vÃ¹ng vá»›i user buffer cÃ³ kÃ­ch thÆ°á»›c lÃ  0x1100:

![](pic2/pic31.PNG)


Lá»—i heap overflow diá»…n ra (Ä‘Ã£ trÃ¬nh bÃ y trong CVE-2020-0796) vÃ  sau khi SMB server giáº£i nÃ©n (trÆ°á»›c khi viá»‡c copy dá»¯ liá»‡u khÃ´ng nÃ©n diá»…n ra) sáº½:

![](pic2/pic32.PNG)

NhÆ° váº­y con trá» UserBufferPtr Ä‘Ã£ trá» vá» Ä‘áº§u `allocation_pool_object_ptr + 0x1650` vÃ  khi quÃ¡ trÃ¬nh copy diá»…n ra thÃ¬ allocation_pool_object_ptr sáº½:

![](pic2/pic33.PNG)

TÆ°Æ¡ng tá»± nhÆ° váº­y, ta sáº½ chÃ¨n thÃªm má»™t sentinel bÃªn dÆ°á»›i báº±ng cÃ¡ch gá»­i gÃ³i tin sau:
``` c
Header:
-   Id = 0x424d53fc
-   OriginalCompressedSegmentSize = 0xffffffff
-   CompressionAlgorithm = 1
-   Flag = 0
-   Offset = 0x2
Data:
data = sentinel
data_to_compress = os.urandom(0x1100 - len(data))
// 0x18 null bytes that override the struct.
data_to_compress += b'\x00'*0x18
// Target address.
data_to_compress += struct.pack('<Q', allocation_pool_object_ptr + 0x1650 + 0x28)
data = data + compress(data_to_compress)
```

NhÆ° váº­y khi SMB server nháº­n gÃ³i tin, nÃ³ sáº½ cáº¥p phÃ¡t vÃ¹ng nhá»› tÆ°Æ¡ng á»©ng, lÃºc nÃ y vÃ¹ng nhá»› Ä‘Æ°á»£c cáº¥p phÃ¡t lÃ  allocation_pool_object_ptr vÃ  nÃ³ sáº½ chá»©a dá»¯ liá»‡u nhÆ° sau:

![](pic2/pic34.PNG)

Sau quÃ¡ trÃ¬nh giáº£i nÃ©n thÃ¬ dá»¯ liá»‡u sáº½ lÃ :

![](pic2/pic35.PNG)

NhÆ° váº­y ta Ä‘Ã£ táº¡o ra 2 unicode string vÃ  hai sentinel Ä‘á»ƒ xÃ¡c thá»±c dá»¯ liá»‡u ta leak Ä‘Æ°á»£c.

Tiáº¿p theo ta sáº½ gá»i hÃ m `RtlCopyUnicodeString` vÃ  truyá»n hai unicode string á»Ÿ trÃªn vÃ o.

Äá»ƒ gá»i Ä‘Æ°á»£c hÃ m `RtlCopyUnicodeString`, trÆ°á»›c tiÃªn ta sáº½ ghi Ä‘Ã¨ con trá» HandlerFunctions thÃ nh Ä‘á»‹a chá»‰ cá»§a hÃ m `RtlCopyUnicodeString`, hÃ m nÃ y Ä‘Æ°á»£c module srvnet import vÃ  cÃ³ offset (theo module cá»§a tÃ´i) lÃ  0x32288.

NhÆ° váº­y vá»›i kÄ© thuáº­t write-what-where, ta sáº½ ghi Ä‘á»‹a chá»‰ 0xFFFFF80060E70000â€¬ + 0x32288 - 0x8 vÃ o HandlerFunctions.

TrÆ°á»›c tiÃªn ta sáº½ leak má»™t con trá» SRVNET_RECV (0xffffe00f0b593dd8).

![](pic2/pic36.PNG)

Ta sáº½ lÆ°u láº¡i káº¿t ná»‘i Ä‘á»ƒ tiáº¿p tá»¥c gá»­i cÃ¡c gÃ³i tin bÃªn dÆ°á»›i.

Tiáº¿p theo ta sáº½ dÃ¹ng kÄ© thuáº­t write-what-where ghi vÃ o con trá» RtlCopyUnicodeString - 0x8 (lÃ­ do - 0x8 lÃ  Ä‘á»ƒ hÃ m RtlCopyUnicodeString thay tháº¿ hÃ m Srv2ReceiveHandler trong HandlerFunctions)

![](pic2/pic37.PNG)

Tiáº¿p Ä‘áº¿n ta sáº½ ghi láº§n lÆ°á»£t 2 con trá» cá»§a 2 unicode string Ä‘Ã£ táº¡o á»Ÿ trÃªn vÃ o 2 Ä‘á»‘i sá»‘ cá»§a HandlerFunction

![](pic2/pic38.PNG)

LÃºc nÃ y, cÃ¹ng má»™t káº¿t ná»‘i, hÃ m Srv2ReceiveHandler Ä‘Ã£ bá»‹ thay báº±ng RtlCopyUnicodeString, vÃ¬ váº­y, khi ta gá»­i má»™t gÃ³i tin Ä‘áº¿n, hÃ m RtlCopyUnicodeString sáº½ Ä‘Æ°á»£c gÃ³i vÃ  copy Unicode String.

![](pic2/pic39.PNG)

Viá»‡c tiáº¿p theo ta cáº§n lÃ m lÃ  leak 10 byte Ä‘á»‹a chá»‰ tá»« 0xffffd38439045670 Ä‘áº¿n 0xffffd3843904567a (bao gá»“m cáº£ 2 sentinel á»Ÿ 2 Ä‘áº§u Ä‘á»‹a chá»‰ cáº§n leak). Sau Ä‘Ã³ kiá»ƒm tra 2 byte á»Ÿ pháº§n Ä‘áº§u vÃ  cuá»‘i cá»§a Ä‘á»‹a chá»‰ leak Ä‘Æ°á»£c cÃ³ pháº£i lÃ  sentinel khÃ´ng, náº¿u lÃ  sentinel thÃ¬ ta Ä‘Ã£ leak Ä‘Ãºng (0xfffff8068152c380).

Sau khi leak Ä‘Æ°á»£c Ä‘á»‹a chá»‰ nt!IoSizeofWorkItem (0xfffff8068152c380), ta sáº½ trá»« Ä‘i offset cá»§a nÃ³ (0x12C380) Ä‘á»ƒ ra Ä‘Æ°á»£c ntoskrnl base address (0xfffff80681400000)

LÆ°u Ã½ lÃ  má»—i offset cá»§a má»—i file module trÃªn cÃ¡c phiÃªn báº£n windows khÃ¡c nhau lÃ  khÃ¡c nhau, vÃ¬ váº­y hÃ£y cháº¯c cháº¯n báº¡n cÃ³ Ä‘Ãºng file module trÃªn mÃ¡y target.

TÆ°Æ¡ng tá»±, sau khi cÃ³ Ä‘Æ°á»£c ntoskrnl base address, ta sáº½ cÃ³ Ä‘Æ°á»£c MiGetPteAddress (0xBA968) vÃ  cÃ³ Ä‘Æ°á»£c PTE base address (MiGetPteAddress + 0x13) : 

![](pic2/pic40.PNG)

BÆ°á»›c tiáº¿p theo, ta sáº½ ghi shellcode vÃ o 0xFFFFF78000000800 báº±ng kÄ© thuáº­t write-what-where. Sau Ä‘Ã³ tÃ­nh toÃ¡n láº¡i Ä‘á»‹a chá»‰ shellcode trong pte thÃ´ng qua cÃ´ng thá»©c bÃªn dÆ°á»›i vÃ  clear bit NX Ä‘á»ƒ Ä‘oáº¡n shellcode cÃ³ thá»ƒ thá»±c thi Ä‘Æ°á»£c: 
``` c
shellcode_addr >>= 9
shellcode_addr &= 0x7FFFFFFFF8
shellcode_addr += pte_base
``` 

Cuá»‘i cÃ¹ng, ta sáº½ ghi Ä‘á»‹a chá»‰ shellcode vÃ o `allocation_pool_object_ptr + 0x50 + 0x1600` vÃ  tiáº¿n hÃ nh gá»i shellcode thÃ´ng qua viá»‡c thay Ä‘á»‹a chá»‰ Ä‘Ã³ vá»›i HandlerFunctions vÃ  truyá»n vÃ o Ä‘á»‘i Ä‘á»‹a chá»‰ nt_base_ptr cho shellcode. 

Táº­n hÆ°á»Ÿng RCE thÃ´i :))

# Tham kháº£o
- [SMBleedingGhost Writeup: Chaining SMBleed (CVE-2020-1206) with SMBGhost](https://blog.zecops.com/vulnerabilities/smbleedingghost-writeup-chaining-smbleed-cve-2020-1206-with-smbghost/)
- [SMBleedingGhost Writeup Part II: Unauthenticated Memory Read â€“ Preparing the Ground for an RCE](https://blog.zecops.com/vulnerabilities/smbleedingghost-writeup-part-ii-unauthenticated-memory-read-preparing-the-ground-for-an-rce/)
- [SMBleedingGhost Writeup Part III: From Remote Read (SMBleed) to RCE](https://blog.zecops.com/vulnerabilities/smbleedingghost-writeup-part-iii-from-remote-read-smbleed-to-rce/)
- [Exploiting SMBGhost (CVE-2020-0796) for a Local Privilege Escalation: Writeup + POC](https://blog.zecops.com/vulnerabilities/exploiting-smbghost-cve-2020-0796-for-a-local-privilege-escalation-writeup-and-poc/)
- [lznt1.py](https://github.com/MITRECND/chopshop/blob/master/ext_libs/lznt1.py)
- [TAKING WINDOWS 10 KERNEL EXPLOITATION TO THE NEXT LEVEL â€“ LEVERAING WRITEWHAT-WHERE VULNERABILITIES IN CREATORS UPDATE](https://www.blackhat.com/docs/us-17/wednesday/us-17-Schenk-Taking-Windows-10-Kernel-Exploitation-To-The-Next-Level%E2%80%93Leveraging-Write-What-Where-Vulnerabilities-In-Creators-Update.pdf)
- [VERGILIUS_MDL](https://www.vergiliusproject.com/kernels/x64/Windows%2010%20%7C%202016/1909%2019H2%20(November%202019%20Update)/_MDL)
- [Exploit Development: Leveraging Page Table Entries for Windows Kernel Exploitation](https://connormcgarr.github.io/pte-overwrites/)
- [RtlUnicodeStringCopy function](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntstrsafe/nf-ntstrsafe-rtlunicodestringcopy)
- [UNICODE_STRING structure](https://docs.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_unicode_string)


<p align="right">
<b><i>DatntSec. Viettel Cyber Security.<i><b>
</p>



## Get the content

```
git clone https://github.com/datntsec/CVE-2020-1206
cd CVE-2020-1206
```

{% embed url="https://github.com/datntsec/CVE-2020-1206" %}

<figure><img src="https://avatars.githubusercontent.com/u/70559607?v=4" alt=""><figcaption><p>datntsec</p></figcaption></figure>
